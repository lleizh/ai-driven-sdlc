#!/usr/bin/env bash

# SDLC CLI Tool
# AI-Driven SDLC ç®¡ç†å·¥å…·ï¼ˆç²¾ç°¡ç‰ˆï¼‰
# å†…å®¹ç”Ÿæˆã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Claude Code slash commandsã‚’ä½¿ç”¨

# Note: Do NOT use 'set -e' in CLI tools - handle errors explicitly
# set -e causes unexpected exits for commands with non-zero status

VERSION="2.0.1"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SDLC_DIR="${SCRIPT_DIR}/sdlc"
TEMPLATES_DIR="${SDLC_DIR}/templates"
FEATURES_DIR="${SDLC_DIR}/features"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Safe .metadata parser
# Prevents arbitrary code execution from malicious .metadata files
# Usage: load_metadata "/path/to/feature/dir"
# Sets global variables: FEATURE_ID, RISK_LEVEL, STATUS, etc.
load_metadata() {
    local metadata_file="$1/.metadata"

    if [[ ! -f "$metadata_file" ]]; then
        print_error ".metadata file not found: $metadata_file"
        return 1
    fi

    # Reset variables to avoid pollution
    unset FEATURE_ID RISK_LEVEL STATUS CREATED_DATE DECISION_STATUS ISSUE_URL BRANCH
    unset REVISION_COUNT LAST_UPDATED

    # Parse .metadata line by line safely (no code execution)
    while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$key" ]] && continue

        # Remove leading/trailing whitespace
        key=$(echo "$key" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        value=$(echo "$value" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

        # Validate key format (alphanumeric and underscore only)
        if [[ ! "$key" =~ ^[A-Z_][A-Z0-9_]*$ ]]; then
            print_warning "Skipping invalid key in .metadata: $key"
            continue
        fi

        # Assign to variables safely
        case "$key" in
            FEATURE_ID) FEATURE_ID="$value" ;;
            RISK_LEVEL) RISK_LEVEL="$value" ;;
            STATUS) STATUS="$value" ;;
            CREATED_DATE) CREATED_DATE="$value" ;;
            DECISION_STATUS) DECISION_STATUS="$value" ;;
            ISSUE_URL) ISSUE_URL="$value" ;;
            BRANCH) BRANCH="$value" ;;
            REVISION_COUNT) REVISION_COUNT="$value" ;;
            LAST_UPDATED) LAST_UPDATED="$value" ;;
            REVISION_*)
                # Handle REVISION_N_DATE, REVISION_N_MAKER, etc.
                eval "$key=\"\$value\""
                ;;
            *)
                print_warning "Unknown metadata key: $key"
                ;;
        esac
    done < "$metadata_file"

    # Validate required fields
    if [[ -z "$FEATURE_ID" ]]; then
        print_error "Missing required field: FEATURE_ID"
        return 1
    fi

    return 0
}

# Validate feature ID format
# Prevents path traversal attacks
# Returns 0 if valid, 1 if invalid
validate_feature_id() {
    local feature_id="$1"

    # Feature ID must match FEATURE-NNN format or similar
    # No path separators, no special characters
    if [[ ! "$feature_id" =~ ^[A-Z]+-[0-9]+$ ]]; then
        print_error "Invalid feature ID format: '$feature_id'"
        print_info "Feature ID must match format: FEATURE-123"
        return 1
    fi

    # Additional check: no path traversal attempts
    if [[ "$feature_id" == *".."* ]] || [[ "$feature_id" == *"/"* ]]; then
        print_error "Security: Path traversal detected in feature ID"
        return 1
    fi

    return 0
}

# Safe arithmetic using awk (no bc dependency)
# Usage: calc "10 / 3" -> 3.33
calc() {
    awk "BEGIN {printf \"%.1f\", $1}"
}

# Safe comparison using awk
# Usage: compare "3.5 > 2" -> returns 0 if true, 1 if false
compare() {
    awk "BEGIN {exit !($1)}"
}

# Portable sed in-place edit
# Works on both GNU and BSD sed
safe_sed_inplace() {
    local pattern="$1"
    local file="$2"

    # Create temp file
    local tmp_file="${file}.tmp.$$"

    sed "$pattern" "$file" > "$tmp_file" || {
        rm -f "$tmp_file"
        return 1
    }

    mv "$tmp_file" "$file" || {
        rm -f "$tmp_file"
        return 1
    }

    return 0
}

print_info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

print_header() {
    echo -e "\n${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

show_help() {
    cat << EOF
SDLC CLI v${VERSION} - ç®¡ç†ãƒ„ãƒ¼ãƒ«

ğŸ“ Featureä½œæˆã¯Claude Code slash commandã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„:
   /sdlc-init <github-issue-url> - GitHub Issueã‹ã‚‰Featureæ–‡æ›¸ã‚’è‡ªå‹•ç”Ÿæˆ

ğŸ”§ ã“ã®CLIã¯ä»¥ä¸‹ã®ç®¡ç†æ©Ÿèƒ½ã‚’æä¾›:

åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰:
  list                              å…¨Featureã®ä¸€è¦§è¡¨ç¤º

  status <feature-id>               Featureã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º

çŠ¶æ…‹ç®¡ç†:
  decision <feature-id> <status>    Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´
                                    status: pending|confirmed|revised

  risk <feature-id> <level>         ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´
                                    level: low|medium|high

æ¤œè¨¼ï¼ˆCI/CDç”¨ï¼‰:
  validate <feature-id>             æ²»ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆæ–‡æ›¸ãƒ»ãƒ—ãƒ­ã‚»ã‚¹æ¤œè¨¼ï¼‰

GitHub Projects åŒæœŸ:
  sync                              å…¨Featureã‚’ GitHub Projects ã«åŒæœŸ
                                    - Feature ID ã§ãƒãƒƒãƒãƒ³ã‚°
                                    - å­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
                                    - Issue URL ãŒãªã„ feature ã¯ã‚¹ã‚­ãƒƒãƒ—

ãƒ¬ãƒãƒ¼ãƒˆ:
  report                            çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

  version                           ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º

  help                              ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾‹:
  # 1. GitHubã§Issueã‚’ä½œæˆï¼ˆfeature.mdãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½¿ç”¨ï¼‰

  # 2. Claude Codeã§æ–‡æ›¸ã‚’è‡ªå‹•ç”Ÿæˆ
  # Claude Codeå†…ã§: /sdlc-init https://github.com/owner/repo/issues/123

  # 3. ç”Ÿæˆã•ã‚ŒãŸæ–‡æ›¸ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»èª¿æ•´

  # 4. Decisionã‚’ç¢ºå®š
  sdlc-cli decision FEATURE-123 confirmed

  # 5. å®Ÿè£…å‰ã«æ¤œè¨¼
  sdlc-cli validate FEATURE-123

  # 6. å®Ÿè£…é–‹å§‹
  git checkout -b feature/FEATURE-123

è©³ç´°: https://github.com/lleizh/ai-driven-sdlc

EOF
}



# Show feature status (with phase tracking)
show_status() {
    local feature_id=$1

    if [[ -z "$feature_id" ]]; then
        print_error "Feature IDãŒå¿…è¦ã§ã™"
        return 1
    fi

    # Validate feature ID format
    if ! validate_feature_id "$feature_id"; then
        return 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        return 1
    fi

    print_header "Feature ${feature_id} ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"

    # Load metadata safely (no code execution)
    if ! load_metadata "${feature_dir}"; then
        return 1
    fi

    # ========================================
    # åŸºæœ¬æƒ…å ±
    # ========================================
    echo "åŸºæœ¬æƒ…å ±:"
    echo "  Feature ID:         ${feature_id}"
    echo "  Issue URL:          ${ISSUE_URL:-æœªè¨­å®š}"
    echo "  ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«:       ${RISK_LEVEL}"
    echo "  ä½œæˆæ—¥:             ${CREATED_DATE}"
    echo ""

    # ========================================
    # ãƒ•ã‚§ãƒ¼ã‚ºé€²æ—ï¼ˆæ²»ç†è¦–ç‚¹ï¼‰
    # ========================================
    echo "ãƒ•ã‚§ãƒ¼ã‚ºé€²æ—:"

    # Phase 1: Planning
    if [[ -f "${feature_dir}/00_context.md" ]] && [[ -s "${feature_dir}/00_context.md" ]]; then
        echo -e "  ${GREEN}âœ“${NC} 1. Planning    - Context ä½œæˆæ¸ˆã¿"
    else
        echo -e "  ${YELLOW}â—${NC} 1. Planning    - Context ä½œæˆä¸­"
    fi

    # Phase 2: Design
    local decision_status=$(grep "^Status:" "${feature_dir}/decisions.md" 2>/dev/null | head -1 | awk '{print $2}')
    if [[ "$decision_status" == "CONFIRMED" ]] || [[ "$decision_status" == "REVISED" ]]; then
        echo -e "  ${GREEN}âœ“${NC} 2. Design      - Decision CONFIRMED"
    elif [[ "$decision_status" == "PENDING" ]]; then
        echo -e "  ${YELLOW}â—${NC} 2. Design      - Decision PENDING (ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­)"
    else
        echo -e "  ${YELLOW}â—‹${NC} 2. Design      - Decision æœªç¢ºå®š"
    fi

    # Phase 3: Implementation
    if [[ -f "${feature_dir}/30_implementation_plan.md" ]] && [[ -s "${feature_dir}/30_implementation_plan.md" ]]; then
        if [[ "$STATUS" == "implementing" ]] || [[ "$STATUS" == "implemented" ]]; then
            echo -e "  ${GREEN}âœ“${NC} 3. Implement   - å®Ÿè£…ä¸­/å®Œäº†"
        else
            echo -e "  ${YELLOW}â—${NC} 3. Implement   - å®Ÿè£…è¨ˆç”»ä½œæˆæ¸ˆã¿"
        fi
    else
        echo -e "  ${YELLOW}â—‹${NC} 3. Implement   - æœªé–‹å§‹"
    fi

    # Phase 4: Review
    if [[ -f "${feature_dir}/40_review_findings.md" ]] && [[ -s "${feature_dir}/40_review_findings.md" ]]; then
        local blocking_count=$(grep -c "Severity: MUST_FIX" "${feature_dir}/40_review_findings.md" 2>/dev/null | xargs || echo "0")
        if [[ $blocking_count -gt 0 ]]; then
            echo -e "  ${RED}âš ${NC} 4. Review      - MUST_FIX å•é¡Œã‚ã‚Š (${blocking_count}ä»¶)"
        else
            echo -e "  ${GREEN}âœ“${NC} 4. Review      - ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†"
        fi
    else
        echo -e "  ${YELLOW}â—‹${NC} 4. Review      - æœªå®Ÿæ–½"
    fi

    echo ""

    # ========================================
    # æ²»ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
    # ========================================
    echo "æ²»ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆç°¡æ˜“ï¼‰:"

    local checks_passed=0
    local checks_total=0

    # Check 1: Issue URL
    ((checks_total++))
    if [[ -n "$ISSUE_URL" ]] && [[ "$ISSUE_URL" != "https://github.com/owner/repo/issues/" ]]; then
        echo -e "  ${GREEN}âœ“${NC} Issue URL è¨­å®šæ¸ˆã¿"
        ((checks_passed++))
    else
        echo -e "  ${RED}âœ—${NC} Issue URL æœªè¨­å®š"
    fi

    # Check 2: Risks
    ((checks_total++))
    local risk_count=$(grep -c "^## Risk" "${feature_dir}/risks.md" 2>/dev/null | xargs || echo "0")
    if [[ $risk_count -gt 0 ]]; then
        echo -e "  ${GREEN}âœ“${NC} ãƒªã‚¹ã‚¯è¨˜éŒ²æ¸ˆã¿ (${risk_count}å€‹)"
        ((checks_passed++))
    else
        echo -e "  ${RED}âœ—${NC} ãƒªã‚¹ã‚¯æœªè¨˜éŒ²"
    fi

    # Check 3: Decision Status
    ((checks_total++))
    if [[ "$decision_status" == "CONFIRMED" ]] || [[ "$decision_status" == "REVISED" ]]; then
        echo -e "  ${GREEN}âœ“${NC} Decision ç¢ºå®šæ¸ˆã¿"
        ((checks_passed++))
    else
        echo -e "  ${YELLOW}â—‹${NC} Decision æœªç¢ºå®š (${decision_status:-PENDING})"
    fi

    # Check 4: Implementation Plan (for Medium/High Risk)
    if [[ "$RISK_LEVEL" != "low" ]]; then
        ((checks_total++))
        if [[ -f "${feature_dir}/30_implementation_plan.md" ]] && [[ -s "${feature_dir}/30_implementation_plan.md" ]]; then
            echo -e "  ${GREEN}âœ“${NC} å®Ÿè£…è¨ˆç”»ä½œæˆæ¸ˆã¿"
            ((checks_passed++))
        else
            echo -e "  ${YELLOW}â—‹${NC} å®Ÿè£…è¨ˆç”»æœªä½œæˆ (${RISK_LEVEL} ãƒªã‚¹ã‚¯)"
        fi
    fi

    echo ""
    echo "  åˆæ ¼ç‡: ${checks_passed}/${checks_total}"
    echo ""

    # ========================================
    # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§
    # ========================================
    echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:"
    for doc in "${feature_dir}"/*.md; do
        if [[ -f "$doc" ]]; then
            local doc_name=$(basename "$doc")
            local line_count=$(wc -l < "$doc" | xargs)
            local status_icon="â—‹"

            if [[ $line_count -gt 10 ]]; then
                status_icon="${GREEN}âœ“${NC}"
            elif [[ $line_count -gt 0 ]]; then
                status_icon="${YELLOW}â—${NC}"
            fi

            echo -e "  ${status_icon} ${doc_name} (${line_count} lines)"
        fi
    done
    echo ""

    # ========================================
    # æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ
    # ========================================
    print_info "æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"

    if [[ -z "$ISSUE_URL" ]] || [[ "$ISSUE_URL" == "https://github.com/owner/repo/issues/" ]]; then
        echo "  â†’ .metadata ã® ISSUE_URL ã‚’è¨­å®š"
    elif [[ $risk_count -eq 0 ]]; then
        echo "  â†’ risks.md ã«ãƒªã‚¹ã‚¯ã‚’è¨˜éŒ²"
    elif [[ "$decision_status" != "CONFIRMED" ]] && [[ "$decision_status" != "REVISED" ]]; then
        echo "  â†’ /sdlc-pr-design ${feature_id} ã§ Design Review ã‚’é–‹å§‹"
        echo "  â†’ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€/sdlc-decision ${feature_id} ã§ Decision ã‚’ç¢ºå®š"
    elif [[ ! -f "${feature_dir}/30_implementation_plan.md" ]] && [[ "$RISK_LEVEL" != "low" ]]; then
        echo "  â†’ /sdlc-impl-plan ${feature_id} ã§å®Ÿè£…è¨ˆç”»ã‚’ç”Ÿæˆ"
    elif [[ "$STATUS" == "implementing" ]] && [[ ! -f "${feature_dir}/40_review_findings.md" ]]; then
        echo "  â†’ /sdlc-check ${feature_id} ã§å®Ÿè£…ã‚’æ¤œè¨¼"
        echo "  â†’ /sdlc-pr-code ${feature_id} ã§ Implementation PR ã‚’ä½œæˆ"
    else
        echo "  â†’ sdlc-cli validate ${feature_id} ã§è©³ç´°ãªæ¤œè¨¼ã‚’å®Ÿè¡Œ"
    fi
}

# Validate feature (Governance Checklist)
validate_feature() {
    local feature_id=$1

    if [[ -z "$feature_id" ]]; then
        print_error "Feature IDãŒå¿…è¦ã§ã™"
        return 1
    fi

    # Validate feature ID format
    if ! validate_feature_id "$feature_id"; then
        return 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        return 1
    fi

    print_header "Feature ${feature_id} ã®æ¤œè¨¼ï¼ˆæ²»ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰"

    # Load metadata safely
    if ! load_metadata "${feature_dir}"; then
        return 1
    fi

    local errors=0
    local warnings=0
    local passed=0
    local total=0

    # ========================================
    # âœ“ Check 1: Issue URL ã®å­˜åœ¨
    # ========================================
    ((total++))
    print_info "[1/8] Issue URL ã®ç¢ºèª..."

    if [[ -n "$ISSUE_URL" ]] && [[ "$ISSUE_URL" != "https://github.com/owner/repo/issues/" ]]; then
        print_success "Issue URL: ${ISSUE_URL}"
        ((passed++))
    else
        print_error "Issue URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        print_info "  â†’ .metadata ã® ISSUE_URL ã‚’è¨­å®šã—ã¦ãã ã•ã„"
        ((errors++))
    fi

    # ========================================
    # âœ“ Check 2: risks.md ã®å­˜åœ¨ã¨å†…å®¹
    # ========================================
    ((total++))
    echo ""
    print_info "[2/8] risks.md ã®ç¢ºèª..."

    if [[ ! -f "${feature_dir}/risks.md" ]]; then
        print_error "risks.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        ((errors++))
    elif [[ ! -s "${feature_dir}/risks.md" ]]; then
        print_error "risks.md ãŒç©ºã§ã™"
        ((errors++))
    else
        local risk_count=$(grep -c "^## Risk" "${feature_dir}/risks.md" 2>/dev/null | xargs || echo "0")
        if [[ $risk_count -gt 0 ]]; then
            print_success "risks.md å­˜åœ¨ï¼ˆ${risk_count}å€‹ã®ãƒªã‚¹ã‚¯è¨˜éŒ²ï¼‰"
            ((passed++))

            # Check if top risks are identified
            local top_risk_count=$(grep -E "Risk Level.*: (High|Medium)" "${feature_dir}/risks.md" 2>/dev/null | wc -l | xargs)
            if [[ $top_risk_count -gt 0 ]]; then
                print_info "  â†’ Top risks: ${top_risk_count}å€‹"
            else
                print_warning "  â†’ High/Medium ãƒªã‚¹ã‚¯ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"
                ((warnings++))
            fi
        else
            print_error "ãƒªã‚¹ã‚¯ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"
            ((errors++))
        fi
    fi

    # ========================================
    # âœ“ Check 3: decisions.md ã® CONFIRMEDï¼ˆå®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã®å ´åˆï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[3/8] decisions.md ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª..."

    if [[ ! -f "${feature_dir}/decisions.md" ]]; then
        print_error "decisions.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        ((errors++))
    else
        local decision_status=$(grep "^Status:" "${feature_dir}/decisions.md" | head -1 | awk '{print $2}')

        if [[ "$STATUS" == "implementing" ]] || [[ "$STATUS" == "implemented" ]]; then
            # å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ CONFIRMED ãŒå¿…é ˆ
            if [[ "$decision_status" == "CONFIRMED" ]] || [[ "$decision_status" == "REVISED" ]]; then
                print_success "Decision Status: ${decision_status}"
                ((passed++))

                # Update metadata
                safe_sed_inplace 's/DECISION_STATUS=.*/DECISION_STATUS=confirmed/' "${feature_dir}/.metadata" 2>/dev/null || true
            else
                print_error "Decision Status: ${decision_status}ï¼ˆå®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ CONFIRMED ãŒå¿…è¦ï¼‰"
                print_info "  â†’ /sdlc-decision ${feature_id} ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
                ((errors++))
            fi
        else
            # è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ PENDING ã‚‚è¨±å®¹
            if [[ -n "$decision_status" ]]; then
                print_success "Decision Status: ${decision_status}ï¼ˆè¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºï¼‰"
                ((passed++))
            else
                print_warning "Decision Status ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
                ((warnings++))
            fi
        fi
    fi

    # ========================================
    # âœ“ Check 4: design.md ãŒ FROZENï¼ˆdecisions CONFIRMED ã®å ´åˆï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[4/8] 20_design.md ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª..."

    if [[ "$RISK_LEVEL" == "low" ]]; then
        print_info "  â†’ Low Risk ã®ãŸã‚è¨­è¨ˆæ–‡æ›¸ã¯ä¸è¦"
        ((passed++))
    elif [[ ! -f "${feature_dir}/20_design.md" ]]; then
        if [[ "$RISK_LEVEL" == "medium" ]]; then
            print_warning "20_design.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆMedium Risk ã§ã¯æ¨å¥¨ï¼‰"
            ((warnings++))
        else
            print_error "20_design.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆHigh Risk ã§ã¯å¿…é ˆï¼‰"
            ((errors++))
        fi
    else
        local design_status=$(grep "^Status:" "${feature_dir}/20_design.md" | head -1 | awk '{print $2}')

        if [[ "$DECISION_STATUS" == "confirmed" ]]; then
            if [[ "$design_status" == "FROZEN" ]]; then
                print_success "Design Status: FROZEN"
                ((passed++))
            else
                print_error "Design Status: ${design_status}ï¼ˆDecision CONFIRMED å¾Œã¯ FROZEN ãŒå¿…è¦ï¼‰"
                print_info "  â†’ /sdlc-decision ã§è‡ªå‹•çš„ã« FROZEN ã«ãªã‚Šã¾ã™"
                ((errors++))
            fi
        else
            print_success "Design Status: ${design_status:-DRAFT}ï¼ˆDecision ç¢ºå®šå‰ï¼‰"
            ((passed++))
        fi
    fi

    # ========================================
    # âœ“ Check 5: 30_implementation_plan.md ã®å­˜åœ¨ï¼ˆä¸­/é«˜ãƒªã‚¹ã‚¯ï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[5/8] 30_implementation_plan.md ã®ç¢ºèª..."

    if [[ "$RISK_LEVEL" == "low" ]]; then
        print_info "  â†’ Low Risk ã®ãŸã‚å®Ÿè£…è¨ˆç”»ã¯ä¸è¦"
        ((passed++))
    elif [[ "$RISK_LEVEL" == "medium" ]]; then
        if [[ -f "${feature_dir}/30_implementation_plan.md" ]] && [[ -s "${feature_dir}/30_implementation_plan.md" ]]; then
            print_success "30_implementation_plan.md å­˜åœ¨"
            ((passed++))
        else
            print_warning "30_implementation_plan.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆMedium Risk ã§ã¯æ¨å¥¨ï¼‰"
            print_info "  â†’ /sdlc-impl-plan ${feature_id} ã§ç”Ÿæˆ"
            ((warnings++))
        fi
    else
        # High Risk
        if [[ -f "${feature_dir}/30_implementation_plan.md" ]] && [[ -s "${feature_dir}/30_implementation_plan.md" ]]; then
            print_success "30_implementation_plan.md å­˜åœ¨"
            ((passed++))
        else
            print_error "30_implementation_plan.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆHigh Risk ã§ã¯å¿…é ˆï¼‰"
            print_info "  â†’ /sdlc-impl-plan ${feature_id} ã§ç”Ÿæˆ"
            ((errors++))
        fi
    fi

    # ========================================
    # âœ“ Check 6: 40_review_findings.md ã®å­˜åœ¨ï¼ˆPRå‰ï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[6/8] 40_review_findings.md ã®ç¢ºèªï¼ˆPRå‰ãƒã‚§ãƒƒã‚¯ï¼‰..."

    if [[ "$STATUS" == "implementing" ]] || [[ "$STATUS" == "implemented" ]]; then
        if [[ -f "${feature_dir}/40_review_findings.md" ]] && [[ -s "${feature_dir}/40_review_findings.md" ]]; then
            print_success "40_review_findings.md å­˜åœ¨"
            ((passed++))

            # Check for blocking issues
            local blocking_count=$(grep -c "Severity: MUST_FIX" "${feature_dir}/40_review_findings.md" 2>/dev/null | xargs || echo "0")
            if [[ $blocking_count -gt 0 ]]; then
                print_error "  â†’ MUST_FIX ã®å•é¡ŒãŒ ${blocking_count} ä»¶ã‚ã‚Šã¾ã™"
                ((errors++))
            fi
        else
            print_warning "40_review_findings.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆPRå‰ã«å®Ÿè¡Œæ¨å¥¨ï¼‰"
            print_info "  â†’ /sdlc-check ${feature_id} ã§ç”Ÿæˆ"
            ((warnings++))
        fi
    else
        print_info "  â†’ å®Ÿè£…å‰ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—"
        ((passed++))
    fi

    # ========================================
    # âœ“ Check 7: 50_test_plan.md ã®å­˜åœ¨ï¼ˆä¸­/é«˜ãƒªã‚¹ã‚¯ï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[7/8] 50_test_plan.md ã®ç¢ºèª..."

    if [[ "$RISK_LEVEL" == "low" ]]; then
        print_info "  â†’ Low Risk ã®ãŸã‚ãƒ†ã‚¹ãƒˆè¨ˆç”»ã¯ä¸è¦"
        ((passed++))
    elif [[ -f "${feature_dir}/50_test_plan.md" ]] && [[ -s "${feature_dir}/50_test_plan.md" ]]; then
        print_success "50_test_plan.md å­˜åœ¨"
        ((passed++))
    else
        if [[ "$RISK_LEVEL" == "high" ]]; then
            print_error "50_test_plan.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆHigh Risk ã§ã¯å¿…é ˆï¼‰"
            ((errors++))
        else
            print_warning "50_test_plan.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆMedium Risk ã§ã¯æ¨å¥¨ï¼‰"
            ((warnings++))
        fi
    fi

    # ========================================
    # âœ“ Check 8: 60_release_plan.md ã®å­˜åœ¨ï¼ˆé«˜ãƒªã‚¹ã‚¯ï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[8/8] 60_release_plan.md ã®ç¢ºèª..."

    if [[ "$RISK_LEVEL" == "high" ]]; then
        if [[ -f "${feature_dir}/60_release_plan.md" ]] && [[ -s "${feature_dir}/60_release_plan.md" ]]; then
            print_success "60_release_plan.md å­˜åœ¨"
            ((passed++))
        else
            print_error "60_release_plan.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆHigh Risk ã§ã¯å¿…é ˆï¼‰"
            ((errors++))
        fi
    else
        print_info "  â†’ Low/Medium Risk ã®ãŸã‚ãƒªãƒªãƒ¼ã‚¹è¨ˆç”»ã¯ä¸è¦"
        ((passed++))
    fi

    # ========================================
    # Summary
    # ========================================
    echo ""
    print_header "æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼"

    echo "æ²»ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:"
    echo "  âœ“ åˆæ ¼: ${passed}/${total}"
    echo "  âš  è­¦å‘Š: ${warnings}"
    echo "  âœ— å¤±æ•—: ${errors}"
    echo ""

    if [[ $errors -eq 0 ]] && [[ $warnings -eq 0 ]]; then
        print_success "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ ğŸ‰"
        echo ""
        print_info "æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
        if [[ "$STATUS" == "planning" ]]; then
            echo "  1. /sdlc-pr-design ${feature_id} ã§ Design Review PR ã‚’ä½œæˆ"
        elif [[ "$STATUS" == "designing" ]]; then
            echo "  1. Design Review ã‚’å®Œäº†"
            echo "  2. /sdlc-decision ${feature_id} ã§ Decision ã‚’ç¢ºå®š"
        elif [[ "$STATUS" == "implementing" ]]; then
            echo "  1. /sdlc-check ${feature_id} ã§å®Ÿè£…ã‚’æ¤œè¨¼"
            echo "  2. /sdlc-pr-code ${feature_id} ã§ Implementation PR ã‚’ä½œæˆ"
        fi
        return 0
    elif [[ $errors -eq 0 ]]; then
        print_warning "è­¦å‘ŠãŒã‚ã‚Šã¾ã™ãŒã€ç¶šè¡Œå¯èƒ½ã§ã™"
        echo ""
        print_info "è­¦å‘Šã‚’è§£æ±ºã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™"
        return 0
    else
        print_error "å¿…é ˆãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
        echo ""
        print_info "ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„"
        return 1
    fi
}

# List all features
list_features() {
    print_header "å…¨Featureä¸€è¦§"

    if [[ ! -d "$FEATURES_DIR" ]] || [[ -z "$(ls -A "$FEATURES_DIR" 2>/dev/null)" ]]; then
        print_info "FeatureãŒã¾ã ã‚ã‚Šã¾ã›ã‚“"
        echo "æ–°ã—ã„Featureã‚’ä½œæˆ: Claude Codeå†…ã§ /sdlc-init <github-issue-url>"
        return
    fi

    printf "%-20s %-10s %-15s %-12s %s\n" "FEATURE ID" "RISK" "STATUS" "DECISION" "CREATED"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ -d "$feature_dir" ]] && [[ -f "${feature_dir}/.metadata" ]]; then
            # Load metadata safely (skip invalid entries)
            if load_metadata "${feature_dir}" 2>/dev/null; then
                local feature_name=$(basename "$feature_dir")

                printf "%-20s %-10s %-15s %-12s %s\n" \
                    "$feature_name" \
                    "${RISK_LEVEL:-unknown}" \
                    "${STATUS:-unknown}" \
                    "${DECISION_STATUS:-unknown}" \
                    "${CREATED_DATE:-unknown}"
            else
                local feature_name=$(basename "$feature_dir")
                printf "%-20s %-10s %-15s %-12s %s\n" \
                    "$feature_name" \
                    "ERROR" \
                    "ERROR" \
                    "ERROR" \
                    "ERROR"
            fi
        fi
    done
}

# Update decision status
update_decision() {
    local feature_id=$1
    local decision_status=$2

    if [[ -z "$feature_id" ]] || [[ -z "$decision_status" ]]; then
        print_error "Feature IDã¨Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¿…è¦ã§ã™"
        echo "ä½¿ç”¨æ–¹æ³•: sdlc-cli decision <feature-id> <pending|confirmed|revised>"
        return 1
    fi

    # Validate feature ID format
    if ! validate_feature_id "$feature_id"; then
        return 1
    fi

    if [[ ! "$decision_status" =~ ^(pending|confirmed|revised)$ ]]; then
        print_error "Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ pending, confirmed, revised ã®ã„ãšã‚Œã‹ã§ã™"
        return 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        return 1
    fi

    # Use safe sed replacement
    if ! safe_sed_inplace "s/DECISION_STATUS=.*/DECISION_STATUS=${decision_status}/" "${feature_dir}/.metadata"; then
        print_error "Failed to update .metadata"
        return 1
    fi

    print_success "Feature ${feature_id} ã®Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ ${decision_status} ã«æ›´æ–°"

    if [[ "$decision_status" == "confirmed" ]]; then
        print_success "å®Ÿè£…ã‚’é–‹å§‹ã§ãã¾ã™ï¼"
    fi
}

# Update risk level
update_risk() {
    local feature_id=$1
    local risk_level=$2

    if [[ -z "$feature_id" ]] || [[ -z "$risk_level" ]]; then
        print_error "Feature IDã¨ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ãŒå¿…è¦ã§ã™"
        echo "ä½¿ç”¨æ–¹æ³•: sdlc-cli risk <feature-id> <low|medium|high>"
        return 1
    fi

    # Validate feature ID format
    if ! validate_feature_id "$feature_id"; then
        return 1
    fi

    if [[ ! "$risk_level" =~ ^(low|medium|high)$ ]]; then
        print_error "ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã¯ low, medium, high ã®ã„ãšã‚Œã‹ã§ã™"
        return 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        return 1
    fi

    # Load metadata to get old risk level
    if ! load_metadata "${feature_dir}"; then
        return 1
    fi
    local old_risk=$RISK_LEVEL

    # Use safe sed replacement
    if ! safe_sed_inplace "s/RISK_LEVEL=.*/RISK_LEVEL=${risk_level}/" "${feature_dir}/.metadata"; then
        print_error "Failed to update .metadata"
        return 1
    fi

    print_success "ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã‚’ ${old_risk} ã‹ã‚‰ ${risk_level} ã«æ›´æ–°"

    if [[ "$risk_level" == "medium" ]] || [[ "$risk_level" == "high" ]]; then
        if [[ ! -f "${feature_dir}/20_design.md" ]]; then
            print_warning "ä¸­/é«˜ãƒªã‚¹ã‚¯ã«ã¯è¨­è¨ˆæ–‡æ›¸ãŒæ¨å¥¨ã•ã‚Œã¾ã™"
        fi
    fi

    if [[ "$risk_level" == "high" ]]; then
        if [[ ! -f "${feature_dir}/30_implementation_plan.md" ]]; then
            print_warning "é«˜ãƒªã‚¹ã‚¯ã«ã¯å®Ÿè£…è¨ˆç”»ãŒå¿…è¦ã§ã™"
        fi
    fi
}

# Generate report (Management Overview)
generate_report() {
    print_header "SDLC ç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆ"

    if [[ ! -d "$FEATURES_DIR" ]] || [[ -z "$(ls -A "$FEATURES_DIR" 2>/dev/null)" ]]; then
        print_info "FeatureãŒã¾ã ã‚ã‚Šã¾ã›ã‚“"
        return
    fi

    # ========================================
    # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿åé›†
    # ========================================
    local total=0
    local low_risk=0
    local medium_risk=0
    local high_risk=0
    local confirmed=0
    local planning=0
    local designing=0
    local implementing=0
    local completed=0
    local blocked=0
    local revision_count=0
    local total_risks=0
    local high_priority_risks=0

    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ -d "$feature_dir" ]] && [[ -f "${feature_dir}/.metadata" ]]; then
            # Load metadata safely (skip invalid entries)
            if ! load_metadata "${feature_dir}" 2>/dev/null; then
                continue
            fi
            ((total++))

            # Risk Level
            case "$RISK_LEVEL" in
                low) ((low_risk++)) ;;
                medium) ((medium_risk++)) ;;
                high) ((high_risk++)) ;;
            esac

            # Decision Status
            if [[ "$DECISION_STATUS" == "confirmed" ]]; then
                ((confirmed++))
            fi

            # Phase
            case "$STATUS" in
                planning) ((planning++)) ;;
                designing) ((designing++)) ;;
                implementing) ((implementing++)) ;;
                completed) ((completed++)) ;;
                blocked) ((blocked++)) ;;
            esac

            # Revisions
            if [[ -f "${feature_dir}/decisions.md" ]]; then
                local revisions=$(grep -c "^## Decision Revision" "${feature_dir}/decisions.md" 2>/dev/null | xargs || echo "0")
                revision_count=$((revision_count + revisions))
            fi

            # Risks
            if [[ -f "${feature_dir}/risks.md" ]]; then
                local risks=$(grep -c "^## Risk" "${feature_dir}/risks.md" 2>/dev/null | xargs || echo "0")
                total_risks=$((total_risks + risks))

                local high_risks=$(grep -E "Risk Level.*: High" "${feature_dir}/risks.md" 2>/dev/null | wc -l | xargs)
                high_priority_risks=$((high_priority_risks + high_risks))
            fi
        fi
    done

    # ========================================
    # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
    # ========================================
    echo "ğŸ“Š Feature ã‚µãƒãƒªãƒ¼"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  ç·Featureæ•°:         ${total}"
    echo "  å®Œäº†:                ${completed}"
    echo "  å®Ÿè£…ä¸­:              ${implementing}"
    echo "  è¨­è¨ˆä¸­:              ${designing}"
    echo "  è¨ˆç”»ä¸­:              ${planning}"
    if [[ $blocked -gt 0 ]]; then
        echo -e "  ${RED}ãƒ–ãƒ­ãƒƒã‚¯ä¸­:          ${blocked}${NC}"
    fi
    echo ""

    # ========================================
    # ãƒªã‚¹ã‚¯åˆ†å¸ƒ
    # ========================================
    echo "âš ï¸  ãƒªã‚¹ã‚¯åˆ†å¸ƒ"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  Low Risk:            ${low_risk}"
    echo "  Medium Risk:         ${medium_risk}"
    if [[ $high_risk -gt 0 ]]; then
        echo -e "  ${YELLOW}High Risk:           ${high_risk}${NC}"
    else
        echo "  High Risk:           ${high_risk}"
    fi
    echo ""
    echo "  ç·ãƒªã‚¹ã‚¯è¨˜éŒ²æ•°:      ${total_risks}"
    if [[ $high_priority_risks -gt 0 ]]; then
        echo -e "  ${RED}High å„ªå…ˆåº¦ãƒªã‚¹ã‚¯:   ${high_priority_risks}${NC}"
    else
        echo "  High å„ªå…ˆåº¦ãƒªã‚¹ã‚¯:   ${high_priority_risks}"
    fi
    echo ""

    # ========================================
    # æ²»ç†ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    # ========================================
    echo "ğŸ” æ²»ç†ãƒ¡ãƒˆãƒªã‚¯ã‚¹"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  Decision ç¢ºå®šæ¸ˆã¿:   ${confirmed}/${total}"

    local decision_rate=0
    if [[ $total -gt 0 ]]; then
        decision_rate=$((confirmed * 100 / total))
    fi

    if [[ $decision_rate -ge 80 ]]; then
        echo -e "  ${GREEN}Decision ç¢ºå®šç‡:     ${decision_rate}%${NC}"
    elif [[ $decision_rate -ge 50 ]]; then
        echo -e "  ${YELLOW}Decision ç¢ºå®šç‡:     ${decision_rate}%${NC}"
    else
        echo -e "  ${RED}Decision ç¢ºå®šç‡:     ${decision_rate}%${NC}"
    fi

    echo "  Decision Revision:   ${revision_count}ä»¶"

    if [[ $revision_count -gt 0 ]] && [[ $total -gt 0 ]]; then
        local avg_revision=$(calc "$revision_count / $total")
        if compare "$avg_revision > 2"; then
            echo -e "  ${RED}å¹³å‡ Revision/Feature: ${avg_revision}${NC} (è¦æ³¨æ„)"
        elif compare "$avg_revision > 1"; then
            echo -e "  ${YELLOW}å¹³å‡ Revision/Feature: ${avg_revision}${NC}"
        else
            echo -e "  ${GREEN}å¹³å‡ Revision/Feature: ${avg_revision}${NC}"
        fi
    fi
    echo ""

    # ========================================
    # å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
    # ========================================
    echo "âœ… ãƒ—ãƒ­ã‚»ã‚¹å¥å…¨æ€§"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    local health_issues=0

    # Check 1: Feature ã« Issue URL ãŒã‚ã‚‹ã‹
    local features_with_issue=0
    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ -d "$feature_dir" ]] && [[ -f "${feature_dir}/.metadata" ]]; then
            # Load metadata safely
            if load_metadata "${feature_dir}" 2>/dev/null; then
                if [[ -n "$ISSUE_URL" ]] && [[ "$ISSUE_URL" != "https://github.com/owner/repo/issues/" ]]; then
                    ((features_with_issue++))
                fi
            fi
        fi
    done

    local issue_rate=$((features_with_issue * 100 / total))
    if [[ $issue_rate -ge 90 ]]; then
        echo -e "  ${GREEN}âœ“${NC} Issue URL è¨­å®šç‡: ${issue_rate}%"
    else
        echo -e "  ${YELLOW}âš ${NC} Issue URL è¨­å®šç‡: ${issue_rate}% (Iron Rule 1 é•åã®å¯èƒ½æ€§)"
        ((health_issues++))
    fi

    # Check 2: Decision ç¢ºå®šç‡
    if [[ $decision_rate -ge 80 ]]; then
        echo -e "  ${GREEN}âœ“${NC} Decision ç¢ºå®šç‡: ${decision_rate}%"
    else
        echo -e "  ${YELLOW}âš ${NC} Decision ç¢ºå®šç‡: ${decision_rate}% (Iron Rule 2 æº–æ‹ ã‚’ç¢ºèª)"
        ((health_issues++))
    fi

    # Check 3: Risk è¨˜éŒ²ç‡
    local features_with_risks=0
    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ -d "$feature_dir" ]] && [[ -f "${feature_dir}/risks.md" ]]; then
            local risks=$(grep -c "^## Risk" "${feature_dir}/risks.md" 2>/dev/null | xargs || echo "0")
            if [[ $risks -gt 0 ]]; then
                ((features_with_risks++))
            fi
        fi
    done

    local risk_rate=$((features_with_risks * 100 / total))
    if [[ $risk_rate -ge 90 ]]; then
        echo -e "  ${GREEN}âœ“${NC} Risk è¨˜éŒ²ç‡: ${risk_rate}%"
    else
        echo -e "  ${YELLOW}âš ${NC} Risk è¨˜éŒ²ç‡: ${risk_rate}% (Iron Rule 3 é•åã®å¯èƒ½æ€§)"
        ((health_issues++))
    fi

    # Check 4: Revision é »åº¦
    if [[ $total -gt 0 ]]; then
        local avg_revision=$(calc "$revision_count / $total")
        if compare "$avg_revision <= 1.5"; then
            echo -e "  ${GREEN}âœ“${NC} Revision é »åº¦: æ­£å¸¸ç¯„å›²"
        else
            echo -e "  ${YELLOW}âš ${NC} Revision é »åº¦: é«˜ã‚ (è¨­è¨ˆå“è³ªã®è¦‹ç›´ã—ã‚’æ¨å¥¨)"
            ((health_issues++))
        fi
    fi

    echo ""

    if [[ $health_issues -eq 0 ]]; then
        print_success "ãƒ—ãƒ­ã‚»ã‚¹ã¯å¥å…¨ã§ã™ ğŸ‰"
    else
        print_warning "${health_issues}ä»¶ã®å¥å…¨æ€§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
    fi

    echo ""

    # ========================================
    # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    # ========================================
    print_info "æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"

    if [[ $planning -gt 0 ]]; then
        echo "  â†’ ${planning}ä»¶ã® Feature ãŒè¨ˆç”»ä¸­ï¼ˆDesign Review ã‚’é€²ã‚ã‚‹ï¼‰"
    fi

    if [[ $designing -gt 0 ]]; then
        echo "  â†’ ${designing}ä»¶ã® Feature ãŒè¨­è¨ˆä¸­ï¼ˆDecision ç¢ºå®šã‚’é€²ã‚ã‚‹ï¼‰"
    fi

    if [[ $blocked -gt 0 ]]; then
        echo -e "  ${RED}â†’ ${blocked}ä»¶ã® Feature ãŒãƒ–ãƒ­ãƒƒã‚¯ä¸­ï¼ˆå„ªå…ˆçš„ã«è§£æ±ºï¼‰${NC}"
    fi

    if [[ $issue_rate -lt 90 ]]; then
        echo "  â†’ Issue URL ãŒæœªè¨­å®šã® Feature ã‚’ç¢ºèª"
    fi

    if [[ $risk_rate -lt 90 ]]; then
        echo "  â†’ ãƒªã‚¹ã‚¯ãŒæœªè¨˜éŒ²ã® Feature ã‚’ç¢ºèª"
    fi

    echo ""
    print_info "è©³ç´°: 'sdlc-cli list' ã¾ãŸã¯ 'sdlc-cli status <feature-id>'"
}

# ========================================
# Sync to GitHub Projects
# ========================================
sync_to_projects() {
    print_info "GitHub Projects ã¸ã®åŒæœŸã‚’é–‹å§‹ã—ã¾ã™"
    echo ""

    # Check .sdlc-config
    if [[ ! -f "${SCRIPT_DIR}/.sdlc-config" ]]; then
        print_error ".sdlc-config ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        print_info "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: ./install.sh ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
        exit 1
    fi

    # Load config
    source "${SCRIPT_DIR}/.sdlc-config"

    if [[ -z "$PROJECT_ID" ]]; then
        print_error "PROJECT_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        exit 1
    fi

    # Check gh CLI
    if ! command -v gh &> /dev/null; then
        print_error "gh CLI ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
        print_info "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: https://cli.github.com/"
        exit 1
    fi

    # Check authentication
    if ! gh auth status &> /dev/null; then
        print_error "GitHub èªè¨¼ãŒå¿…è¦ã§ã™"
        print_info "å®Ÿè¡Œ: gh auth login"
        exit 1
    fi

    echo "Project ID: $PROJECT_ID"
    echo ""

    # Get all features
    local feature_count=0
    local synced_count=0
    local skipped_count=0
    local error_count=0

    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ ! -d "$feature_dir" ]]; then
            continue
        fi

        if [[ ! -f "${feature_dir}/.metadata" ]]; then
            continue
        fi

        ((feature_count++))

        # Load metadata
        if ! load_metadata "${feature_dir}"; then
            print_warning "Failed to load metadata: ${feature_dir}"
            ((error_count++))
            continue
        fi

        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "Feature: ${FEATURE_ID}"

        # Skip if no Issue URL
        if [[ -z "$ISSUE_URL" ]] || [[ "$ISSUE_URL" == "https://github.com/owner/repo/issues/" ]]; then
            print_warning "Issue URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—"
            ((skipped_count++))
            echo ""
            continue
        fi

        # Extract issue number from URL
        local issue_number
        issue_number=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')

        if [[ -z "$issue_number" ]]; then
            print_warning "Issue URL ã‹ã‚‰ Issue ç•ªå·ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“: $ISSUE_URL"
            ((error_count++))
            echo ""
            continue
        fi

        echo "Issue: #${issue_number}"

        # Get Issue node ID
        local issue_node_id
        issue_node_id=$(gh api graphql -f query='
          query($owner: String!, $repo: String!, $number: Int!) {
            repository(owner: $owner, name: $repo) {
              issue(number: $number) {
                id
              }
            }
          }
        ' -f owner="$REPO_OWNER" \
          -f repo="$REPO_NAME" \
          -F number="$issue_number" \
          --jq '.data.repository.issue.id' 2>/dev/null)

        if [[ -z "$issue_node_id" ]] || [[ "$issue_node_id" == "null" ]]; then
            print_error "Issue ã® node ID ã‚’å–å¾—ã§ãã¾ã›ã‚“: Issue #${issue_number}"
            ((error_count++))
            echo ""
            continue
        fi

        # Check if Item exists in Project by Feature ID
        local existing_item_id
        existing_item_id=$(gh api graphql -f query='
          query($projectId: ID!) {
            node(id: $projectId) {
              ... on ProjectV2 {
                items(first: 100) {
                  nodes {
                    id
                    content {
                      ... on Issue {
                        id
                        number
                      }
                    }
                    fieldValues(first: 20) {
                      nodes {
                        ... on ProjectV2ItemFieldTextValue {
                          text
                          field {
                            ... on ProjectV2Field {
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        ' -f projectId="$PROJECT_ID" \
          --jq ".data.node.items.nodes[] | select(.fieldValues.nodes[] | select(.field.name == \"Feature ID\" and .text == \"$FEATURE_ID\")) | .id" 2>/dev/null || true)

        # If not found by Feature ID, check by Issue content ID
        if [[ -z "$existing_item_id" ]]; then
            existing_item_id=$(gh api graphql -f query='
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            ' -f projectId="$PROJECT_ID" \
              --jq ".data.node.items.nodes[] | select(.content.id == \"$issue_node_id\") | .id" 2>/dev/null || true)
        fi

        local item_id="$existing_item_id"

        # Add Item if not exists
        if [[ -z "$item_id" ]]; then
            echo "Project ã« Item ã‚’è¿½åŠ ä¸­..."

            item_id=$(gh api graphql -f query='
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $projectId
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }
            ' -f projectId="$PROJECT_ID" \
              -f contentId="$issue_node_id" \
              --jq '.data.addProjectV2ItemById.item.id' 2>/dev/null)

            if [[ -z "$item_id" ]] || [[ "$item_id" == "null" ]]; then
                print_error "Item ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ"
                ((error_count++))
                echo ""
                continue
            fi

            print_success "Item ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
        else
            echo "âœ“ Item ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
        fi

        # Get field options
        local field_options
        field_options=$(gh api graphql -f query='
          query($projectId: ID!) {
            node(id: $projectId) {
              ... on ProjectV2 {
                fields(first: 20) {
                  nodes {
                    ... on ProjectV2SingleSelectField {
                      id
                      name
                      options { id name }
                    }
                  }
                }
              }
            }
          }
        ' -f projectId="$PROJECT_ID" 2>/dev/null)

        # Update Status field
        if [[ -n "$STATUS" ]]; then
            local project_status
            case "$STATUS" in
                "planning") project_status="Planning" ;;
                "implementing") project_status="Implementing" ;;
                "testing") project_status="Testing" ;;
                "completed") project_status="Completed" ;;
                "on-hold") project_status="On Hold" ;;
                *) project_status="" ;;
            esac

            if [[ -n "$project_status" ]]; then
                local status_option_id
                status_option_id=$(echo "$field_options" | jq -r --arg name "$project_status" '.data.node.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == $name) | .id')

                if [[ -n "$status_option_id" ]] && [[ "$status_option_id" != "null" ]]; then
                    if gh api graphql -f query='
                      mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                        updateProjectV2ItemFieldValue(input: {
                          projectId: $projectId
                          itemId: $itemId
                          fieldId: $fieldId
                          value: { singleSelectOptionId: $optionId }
                        }) {
                          projectV2Item { id }
                        }
                      }
                    ' -f projectId="$PROJECT_ID" \
                      -f itemId="$item_id" \
                      -f fieldId="$FIELD_ID_STATUS" \
                      -f optionId="$status_option_id" > /dev/null 2>&1; then
                        echo "  âœ“ Status: $project_status"
                    fi
                fi
            fi
        fi

        # Update Feature ID field
        if [[ -n "$FEATURE_ID" ]]; then
            if gh api graphql -f query='
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $text: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { text: $text }
                }) {
                  projectV2Item { id }
                }
              }
            ' -f projectId="$PROJECT_ID" \
              -f itemId="$item_id" \
              -f fieldId="$FIELD_ID_FEATURE_ID" \
              -f text="$FEATURE_ID" > /dev/null 2>&1; then
                echo "  âœ“ Feature ID: $FEATURE_ID"
            fi
        fi

        # Update Risk Level field
        if [[ -n "$RISK_LEVEL" ]]; then
            local project_risk
            case "$RISK_LEVEL" in
                "low") project_risk="Low" ;;
                "medium") project_risk="Medium" ;;
                "high") project_risk="High" ;;
                *) project_risk="" ;;
            esac

            if [[ -n "$project_risk" ]]; then
                local risk_option_id
                risk_option_id=$(echo "$field_options" | jq -r --arg name "$project_risk" '.data.node.fields.nodes[] | select(.name == "Risk Level") | .options[] | select(.name == $name) | .id')

                if [[ -n "$risk_option_id" ]] && [[ "$risk_option_id" != "null" ]]; then
                    if gh api graphql -f query='
                      mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                        updateProjectV2ItemFieldValue(input: {
                          projectId: $projectId
                          itemId: $itemId
                          fieldId: $fieldId
                          value: { singleSelectOptionId: $optionId }
                        }) {
                          projectV2Item { id }
                        }
                      }
                    ' -f projectId="$PROJECT_ID" \
                      -f itemId="$item_id" \
                      -f fieldId="$FIELD_ID_RISK_LEVEL" \
                      -f optionId="$risk_option_id" > /dev/null 2>&1; then
                        echo "  âœ“ Risk Level: $project_risk"
                    fi
                fi
            fi
        fi

        # Update Decision Status field
        if [[ -n "$DECISION_STATUS" ]]; then
            local project_decision
            case "$DECISION_STATUS" in
                "pending") project_decision="Pending" ;;
                "confirmed") project_decision="Confirmed" ;;
                "rejected") project_decision="Rejected" ;;
                *) project_decision="" ;;
            esac

            if [[ -n "$project_decision" ]]; then
                local decision_option_id
                decision_option_id=$(echo "$field_options" | jq -r --arg name "$project_decision" '.data.node.fields.nodes[] | select(.name == \"Decision Status\") | .options[] | select(.name == \$name) | .id')

                if [[ -n "$decision_option_id" ]] && [[ "$decision_option_id" != "null" ]]; then
                    if gh api graphql -f query='
                      mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                        updateProjectV2ItemFieldValue(input: {
                          projectId: $projectId
                          itemId: $itemId
                          fieldId: $fieldId
                          value: { singleSelectOptionId: $optionId }
                        }) {
                          projectV2Item { id }
                        }
                      }
                    ' -f projectId="$PROJECT_ID" \
                      -f itemId="$item_id" \
                      -f fieldId="$FIELD_ID_DECISION_STATUS" \
                      -f optionId="$decision_option_id" > /dev/null 2>&1; then
                        echo "  âœ“ Decision Status: $project_decision"
                    fi
                fi
            fi
        fi

        print_success "${FEATURE_ID} ã®åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ"
        ((synced_count++))
        echo ""
    done

    # Summary
    echo "========================================"
    print_success "åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ"
    echo "========================================"
    echo "  ç· Feature æ•°:       ${feature_count}"
    echo "  åŒæœŸæˆåŠŸ:            ${synced_count}"
    echo "  ã‚¹ã‚­ãƒƒãƒ—:            ${skipped_count}"
    if [[ $error_count -gt 0 ]]; then
        echo -e "  ${RED}ã‚¨ãƒ©ãƒ¼:              ${error_count}${NC}"
    else
        echo "  ã‚¨ãƒ©ãƒ¼:              ${error_count}"
    fi
    echo ""
}

# Main
main() {
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    local command=$1
    shift

    case "$command" in
        status)
            show_status "$@"
            ;;
        validate)
            validate_feature "$@"
            ;;
        list)
            list_features
            ;;
        decision)
            update_decision "$@"
            ;;
        risk)
            update_risk "$@"
            ;;
        report)
            generate_report
            ;;
        sync)
            sync_to_projects "$@"
            ;;
        version)
            echo "SDLC CLI version ${VERSION}"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: ${command}"
            echo "ä½¿ç”¨æ–¹æ³•: sdlc-cli help"
            exit 1
            ;;
    esac
}

main "$@"
