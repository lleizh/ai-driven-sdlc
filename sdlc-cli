#!/usr/bin/env bash

# SDLC CLI Tool
# AI-Driven SDLC ç®¡ç†å·¥å…·ï¼ˆç²¾ç°¡ç‰ˆï¼‰
# å†…å®¹ç”Ÿæˆã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Claude Code slash commandsã‚’ä½¿ç”¨

set -e

VERSION="2.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SDLC_DIR="${SCRIPT_DIR}/sdlc"
TEMPLATES_DIR="${SDLC_DIR}/templates"
FEATURES_DIR="${SDLC_DIR}/features"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

print_header() {
    echo -e "\n${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

show_help() {
    cat << EOF
SDLC CLI v${VERSION} - ç®¡ç†ãƒ„ãƒ¼ãƒ«

ğŸ“ Featureä½œæˆã¯Claude Code slash commandã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„:
   /sdlc-init <github-issue-url> - GitHub Issueã‹ã‚‰Featureæ–‡æ›¸ã‚’è‡ªå‹•ç”Ÿæˆ

ğŸ”§ ã“ã®CLIã¯ä»¥ä¸‹ã®ç®¡ç†æ©Ÿèƒ½ã‚’æä¾›:

åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰:
  list                              å…¨Featureã®ä¸€è¦§è¡¨ç¤º

  status <feature-id>               Featureã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º

çŠ¶æ…‹ç®¡ç†:
  decision <feature-id> <status>    Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´
                                    status: pending|confirmed|revised

  risk <feature-id> <level>         ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´
                                    level: low|medium|high

æ¤œè¨¼ï¼ˆCI/CDç”¨ï¼‰:
  validate <feature-id>             Decisionã¨Riskã®æ¤œè¨¼

  check <feature-id>                å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯

ãƒ¬ãƒãƒ¼ãƒˆ:
  report                            çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

  version                           ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º

  help                              ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾‹:
  # 1. GitHubã§Issueã‚’ä½œæˆï¼ˆfeature.mdãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½¿ç”¨ï¼‰

  # 2. Claude Codeã§æ–‡æ›¸ã‚’è‡ªå‹•ç”Ÿæˆ
  # Claude Codeå†…ã§: /sdlc-init https://github.com/owner/repo/issues/123

  # 3. ç”Ÿæˆã•ã‚ŒãŸæ–‡æ›¸ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»èª¿æ•´

  # 4. Decisionã‚’ç¢ºå®š
  sdlc-cli decision FEATURE-123 confirmed

  # 5. å®Ÿè£…å‰ã«æ¤œè¨¼
  sdlc-cli validate FEATURE-123

  # 6. å®Ÿè£…é–‹å§‹
  git checkout -b feature/FEATURE-123

è©³ç´°: https://github.com/yourusername/ai-driven-sdlc

EOF
}



# Show feature status (with phase tracking)
show_status() {
    local feature_id=$1

    if [[ -z "$feature_id" ]]; then
        print_error "Feature IDãŒå¿…è¦ã§ã™"
        exit 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    print_header "Feature ${feature_id} ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"

    source "${feature_dir}/.metadata"

    # ========================================
    # åŸºæœ¬æƒ…å ±
    # ========================================
    echo "åŸºæœ¬æƒ…å ±:"
    echo "  Feature ID:         ${feature_id}"
    echo "  Issue URL:          ${ISSUE_URL:-æœªè¨­å®š}"
    echo "  ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«:       ${RISK_LEVEL}"
    echo "  ä½œæˆæ—¥:             ${CREATED_DATE}"
    echo ""

    # ========================================
    # ãƒ•ã‚§ãƒ¼ã‚ºé€²æ—ï¼ˆæ²»ç†è¦–ç‚¹ï¼‰
    # ========================================
    echo "ãƒ•ã‚§ãƒ¼ã‚ºé€²æ—:"

    # Phase 1: Planning
    if [[ -f "${feature_dir}/00_context.md" ]] && [[ -s "${feature_dir}/00_context.md" ]]; then
        echo -e "  ${GREEN}âœ“${NC} 1. Planning    - Context ä½œæˆæ¸ˆã¿"
    else
        echo -e "  ${YELLOW}â—${NC} 1. Planning    - Context ä½œæˆä¸­"
    fi

    # Phase 2: Design
    local decision_status=$(grep "^Status:" "${feature_dir}/decisions.md" 2>/dev/null | head -1 | awk '{print $2}')
    if [[ "$decision_status" == "CONFIRMED" ]] || [[ "$decision_status" == "REVISED" ]]; then
        echo -e "  ${GREEN}âœ“${NC} 2. Design      - Decision CONFIRMED"
    elif [[ "$decision_status" == "PENDING" ]]; then
        echo -e "  ${YELLOW}â—${NC} 2. Design      - Decision PENDING (ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­)"
    else
        echo -e "  ${YELLOW}â—‹${NC} 2. Design      - Decision æœªç¢ºå®š"
    fi

    # Phase 3: Implementation
    if [[ -f "${feature_dir}/30_implementation_plan.md" ]] && [[ -s "${feature_dir}/30_implementation_plan.md" ]]; then
        if [[ "$STATUS" == "implementing" ]] || [[ "$STATUS" == "implemented" ]]; then
            echo -e "  ${GREEN}âœ“${NC} 3. Implement   - å®Ÿè£…ä¸­/å®Œäº†"
        else
            echo -e "  ${YELLOW}â—${NC} 3. Implement   - å®Ÿè£…è¨ˆç”»ä½œæˆæ¸ˆã¿"
        fi
    else
        echo -e "  ${YELLOW}â—‹${NC} 3. Implement   - æœªé–‹å§‹"
    fi

    # Phase 4: Review
    if [[ -f "${feature_dir}/40_review_findings.md" ]] && [[ -s "${feature_dir}/40_review_findings.md" ]]; then
        local blocking_count=$(grep -c "Severity: MUST_FIX" "${feature_dir}/40_review_findings.md" 2>/dev/null || echo "0")
        if [[ $blocking_count -gt 0 ]]; then
            echo -e "  ${RED}âš ${NC} 4. Review      - MUST_FIX å•é¡Œã‚ã‚Š (${blocking_count}ä»¶)"
        else
            echo -e "  ${GREEN}âœ“${NC} 4. Review      - ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†"
        fi
    else
        echo -e "  ${YELLOW}â—‹${NC} 4. Review      - æœªå®Ÿæ–½"
    fi

    echo ""

    # ========================================
    # æ²»ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
    # ========================================
    echo "æ²»ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆç°¡æ˜“ï¼‰:"

    local checks_passed=0
    local checks_total=0

    # Check 1: Issue URL
    ((checks_total++))
    if [[ -n "$ISSUE_URL" ]] && [[ "$ISSUE_URL" != "https://github.com/owner/repo/issues/" ]]; then
        echo -e "  ${GREEN}âœ“${NC} Issue URL è¨­å®šæ¸ˆã¿"
        ((checks_passed++))
    else
        echo -e "  ${RED}âœ—${NC} Issue URL æœªè¨­å®š"
    fi

    # Check 2: Risks
    ((checks_total++))
    local risk_count=$(grep -c "^## Risk" "${feature_dir}/risks.md" 2>/dev/null || echo "0")
    if [[ $risk_count -gt 0 ]]; then
        echo -e "  ${GREEN}âœ“${NC} ãƒªã‚¹ã‚¯è¨˜éŒ²æ¸ˆã¿ (${risk_count}å€‹)"
        ((checks_passed++))
    else
        echo -e "  ${RED}âœ—${NC} ãƒªã‚¹ã‚¯æœªè¨˜éŒ²"
    fi

    # Check 3: Decision Status
    ((checks_total++))
    if [[ "$decision_status" == "CONFIRMED" ]] || [[ "$decision_status" == "REVISED" ]]; then
        echo -e "  ${GREEN}âœ“${NC} Decision ç¢ºå®šæ¸ˆã¿"
        ((checks_passed++))
    else
        echo -e "  ${YELLOW}â—‹${NC} Decision æœªç¢ºå®š (${decision_status:-PENDING})"
    fi

    # Check 4: Implementation Plan (for Medium/High Risk)
    if [[ "$RISK_LEVEL" != "low" ]]; then
        ((checks_total++))
        if [[ -f "${feature_dir}/30_implementation_plan.md" ]] && [[ -s "${feature_dir}/30_implementation_plan.md" ]]; then
            echo -e "  ${GREEN}âœ“${NC} å®Ÿè£…è¨ˆç”»ä½œæˆæ¸ˆã¿"
            ((checks_passed++))
        else
            echo -e "  ${YELLOW}â—‹${NC} å®Ÿè£…è¨ˆç”»æœªä½œæˆ (${RISK_LEVEL} ãƒªã‚¹ã‚¯)"
        fi
    fi

    echo ""
    echo "  åˆæ ¼ç‡: ${checks_passed}/${checks_total}"
    echo ""

    # ========================================
    # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§
    # ========================================
    echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:"
    for doc in "${feature_dir}"/*.md; do
        if [[ -f "$doc" ]]; then
            local doc_name=$(basename "$doc")
            local line_count=$(wc -l < "$doc" | xargs)
            local status_icon="â—‹"

            if [[ $line_count -gt 10 ]]; then
                status_icon="${GREEN}âœ“${NC}"
            elif [[ $line_count -gt 0 ]]; then
                status_icon="${YELLOW}â—${NC}"
            fi

            echo -e "  ${status_icon} ${doc_name} (${line_count} lines)"
        fi
    done
    echo ""

    # ========================================
    # æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ
    # ========================================
    print_info "æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"

    if [[ -z "$ISSUE_URL" ]] || [[ "$ISSUE_URL" == "https://github.com/owner/repo/issues/" ]]; then
        echo "  â†’ .metadata ã® ISSUE_URL ã‚’è¨­å®š"
    elif [[ $risk_count -eq 0 ]]; then
        echo "  â†’ risks.md ã«ãƒªã‚¹ã‚¯ã‚’è¨˜éŒ²"
    elif [[ "$decision_status" != "CONFIRMED" ]] && [[ "$decision_status" != "REVISED" ]]; then
        echo "  â†’ /sdlc-pr-design ${feature_id} ã§ Design Review ã‚’é–‹å§‹"
        echo "  â†’ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€/sdlc-decision ${feature_id} ã§ Decision ã‚’ç¢ºå®š"
    elif [[ ! -f "${feature_dir}/30_implementation_plan.md" ]] && [[ "$RISK_LEVEL" != "low" ]]; then
        echo "  â†’ /sdlc-impl-plan ${feature_id} ã§å®Ÿè£…è¨ˆç”»ã‚’ç”Ÿæˆ"
    elif [[ "$STATUS" == "implementing" ]] && [[ ! -f "${feature_dir}/40_review_findings.md" ]]; then
        echo "  â†’ /sdlc-check ${feature_id} ã§å®Ÿè£…ã‚’æ¤œè¨¼"
        echo "  â†’ /sdlc-pr-code ${feature_id} ã§ Implementation PR ã‚’ä½œæˆ"
    else
        echo "  â†’ sdlc-cli validate ${feature_id} ã§è©³ç´°ãªæ¤œè¨¼ã‚’å®Ÿè¡Œ"
    fi
}

# Validate feature (Governance Checklist)
validate_feature() {
    local feature_id=$1

    if [[ -z "$feature_id" ]]; then
        print_error "Feature IDãŒå¿…è¦ã§ã™"
        exit 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    print_header "Feature ${feature_id} ã®æ¤œè¨¼ï¼ˆæ²»ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰"

    source "${feature_dir}/.metadata"

    local errors=0
    local warnings=0
    local passed=0
    local total=0

    # ========================================
    # âœ“ Check 1: Issue URL ã®å­˜åœ¨
    # ========================================
    ((total++))
    print_info "[1/8] Issue URL ã®ç¢ºèª..."

    if [[ -n "$ISSUE_URL" ]] && [[ "$ISSUE_URL" != "https://github.com/owner/repo/issues/" ]]; then
        print_success "Issue URL: ${ISSUE_URL}"
        ((passed++))
    else
        print_error "Issue URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        print_info "  â†’ .metadata ã® ISSUE_URL ã‚’è¨­å®šã—ã¦ãã ã•ã„"
        ((errors++))
    fi

    # ========================================
    # âœ“ Check 2: risks.md ã®å­˜åœ¨ã¨å†…å®¹
    # ========================================
    ((total++))
    echo ""
    print_info "[2/8] risks.md ã®ç¢ºèª..."

    if [[ ! -f "${feature_dir}/risks.md" ]]; then
        print_error "risks.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        ((errors++))
    elif [[ ! -s "${feature_dir}/risks.md" ]]; then
        print_error "risks.md ãŒç©ºã§ã™"
        ((errors++))
    else
        local risk_count=$(grep -c "^## Risk" "${feature_dir}/risks.md" 2>/dev/null || echo "0")
        if [[ $risk_count -gt 0 ]]; then
            print_success "risks.md å­˜åœ¨ï¼ˆ${risk_count}å€‹ã®ãƒªã‚¹ã‚¯è¨˜éŒ²ï¼‰"
            ((passed++))

            # Check if top risks are identified
            local top_risk_count=$(grep -E "Risk Level.*: (High|Medium)" "${feature_dir}/risks.md" 2>/dev/null | wc -l | xargs)
            if [[ $top_risk_count -gt 0 ]]; then
                print_info "  â†’ Top risks: ${top_risk_count}å€‹"
            else
                print_warning "  â†’ High/Medium ãƒªã‚¹ã‚¯ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"
                ((warnings++))
            fi
        else
            print_error "ãƒªã‚¹ã‚¯ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"
            ((errors++))
        fi
    fi

    # ========================================
    # âœ“ Check 3: decisions.md ã® CONFIRMEDï¼ˆå®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã®å ´åˆï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[3/8] decisions.md ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª..."

    if [[ ! -f "${feature_dir}/decisions.md" ]]; then
        print_error "decisions.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        ((errors++))
    else
        local decision_status=$(grep "^Status:" "${feature_dir}/decisions.md" | head -1 | awk '{print $2}')

        if [[ "$STATUS" == "implementing" ]] || [[ "$STATUS" == "implemented" ]]; then
            # å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ CONFIRMED ãŒå¿…é ˆ
            if [[ "$decision_status" == "CONFIRMED" ]] || [[ "$decision_status" == "REVISED" ]]; then
                print_success "Decision Status: ${decision_status}"
                ((passed++))

                # Update metadata
                sed -i.bak 's/DECISION_STATUS=.*/DECISION_STATUS=confirmed/' "${feature_dir}/.metadata"
                rm -f "${feature_dir}/.metadata.bak"
            else
                print_error "Decision Status: ${decision_status}ï¼ˆå®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ CONFIRMED ãŒå¿…è¦ï¼‰"
                print_info "  â†’ /sdlc-decision ${feature_id} ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
                ((errors++))
            fi
        else
            # è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºã§ã¯ PENDING ã‚‚è¨±å®¹
            if [[ -n "$decision_status" ]]; then
                print_success "Decision Status: ${decision_status}ï¼ˆè¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºï¼‰"
                ((passed++))
            else
                print_warning "Decision Status ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
                ((warnings++))
            fi
        fi
    fi

    # ========================================
    # âœ“ Check 4: design.md ãŒ FROZENï¼ˆdecisions CONFIRMED ã®å ´åˆï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[4/8] 20_design.md ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª..."

    if [[ "$RISK_LEVEL" == "low" ]]; then
        print_info "  â†’ Low Risk ã®ãŸã‚è¨­è¨ˆæ–‡æ›¸ã¯ä¸è¦"
        ((passed++))
    elif [[ ! -f "${feature_dir}/20_design.md" ]]; then
        if [[ "$RISK_LEVEL" == "medium" ]]; then
            print_warning "20_design.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆMedium Risk ã§ã¯æ¨å¥¨ï¼‰"
            ((warnings++))
        else
            print_error "20_design.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆHigh Risk ã§ã¯å¿…é ˆï¼‰"
            ((errors++))
        fi
    else
        local design_status=$(grep "^Status:" "${feature_dir}/20_design.md" | head -1 | awk '{print $2}')

        if [[ "$DECISION_STATUS" == "confirmed" ]]; then
            if [[ "$design_status" == "FROZEN" ]]; then
                print_success "Design Status: FROZEN"
                ((passed++))
            else
                print_error "Design Status: ${design_status}ï¼ˆDecision CONFIRMED å¾Œã¯ FROZEN ãŒå¿…è¦ï¼‰"
                print_info "  â†’ /sdlc-decision ã§è‡ªå‹•çš„ã« FROZEN ã«ãªã‚Šã¾ã™"
                ((errors++))
            fi
        else
            print_success "Design Status: ${design_status:-DRAFT}ï¼ˆDecision ç¢ºå®šå‰ï¼‰"
            ((passed++))
        fi
    fi

    # ========================================
    # âœ“ Check 5: 30_implementation_plan.md ã®å­˜åœ¨ï¼ˆä¸­/é«˜ãƒªã‚¹ã‚¯ï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[5/8] 30_implementation_plan.md ã®ç¢ºèª..."

    if [[ "$RISK_LEVEL" == "low" ]]; then
        print_info "  â†’ Low Risk ã®ãŸã‚å®Ÿè£…è¨ˆç”»ã¯ä¸è¦"
        ((passed++))
    elif [[ "$RISK_LEVEL" == "medium" ]]; then
        if [[ -f "${feature_dir}/30_implementation_plan.md" ]] && [[ -s "${feature_dir}/30_implementation_plan.md" ]]; then
            print_success "30_implementation_plan.md å­˜åœ¨"
            ((passed++))
        else
            print_warning "30_implementation_plan.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆMedium Risk ã§ã¯æ¨å¥¨ï¼‰"
            print_info "  â†’ /sdlc-impl-plan ${feature_id} ã§ç”Ÿæˆ"
            ((warnings++))
        fi
    else
        # High Risk
        if [[ -f "${feature_dir}/30_implementation_plan.md" ]] && [[ -s "${feature_dir}/30_implementation_plan.md" ]]; then
            print_success "30_implementation_plan.md å­˜åœ¨"
            ((passed++))
        else
            print_error "30_implementation_plan.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆHigh Risk ã§ã¯å¿…é ˆï¼‰"
            print_info "  â†’ /sdlc-impl-plan ${feature_id} ã§ç”Ÿæˆ"
            ((errors++))
        fi
    fi

    # ========================================
    # âœ“ Check 6: 40_review_findings.md ã®å­˜åœ¨ï¼ˆPRå‰ï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[6/8] 40_review_findings.md ã®ç¢ºèªï¼ˆPRå‰ãƒã‚§ãƒƒã‚¯ï¼‰..."

    if [[ "$STATUS" == "implementing" ]] || [[ "$STATUS" == "implemented" ]]; then
        if [[ -f "${feature_dir}/40_review_findings.md" ]] && [[ -s "${feature_dir}/40_review_findings.md" ]]; then
            print_success "40_review_findings.md å­˜åœ¨"
            ((passed++))

            # Check for blocking issues
            local blocking_count=$(grep -c "Severity: MUST_FIX" "${feature_dir}/40_review_findings.md" 2>/dev/null || echo "0")
            if [[ $blocking_count -gt 0 ]]; then
                print_error "  â†’ MUST_FIX ã®å•é¡ŒãŒ ${blocking_count} ä»¶ã‚ã‚Šã¾ã™"
                ((errors++))
            fi
        else
            print_warning "40_review_findings.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆPRå‰ã«å®Ÿè¡Œæ¨å¥¨ï¼‰"
            print_info "  â†’ /sdlc-check ${feature_id} ã§ç”Ÿæˆ"
            ((warnings++))
        fi
    else
        print_info "  â†’ å®Ÿè£…å‰ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—"
        ((passed++))
    fi

    # ========================================
    # âœ“ Check 7: 50_test_plan.md ã®å­˜åœ¨ï¼ˆä¸­/é«˜ãƒªã‚¹ã‚¯ï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[7/8] 50_test_plan.md ã®ç¢ºèª..."

    if [[ "$RISK_LEVEL" == "low" ]]; then
        print_info "  â†’ Low Risk ã®ãŸã‚ãƒ†ã‚¹ãƒˆè¨ˆç”»ã¯ä¸è¦"
        ((passed++))
    elif [[ -f "${feature_dir}/50_test_plan.md" ]] && [[ -s "${feature_dir}/50_test_plan.md" ]]; then
        print_success "50_test_plan.md å­˜åœ¨"
        ((passed++))
    else
        if [[ "$RISK_LEVEL" == "high" ]]; then
            print_error "50_test_plan.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆHigh Risk ã§ã¯å¿…é ˆï¼‰"
            ((errors++))
        else
            print_warning "50_test_plan.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆMedium Risk ã§ã¯æ¨å¥¨ï¼‰"
            ((warnings++))
        fi
    fi

    # ========================================
    # âœ“ Check 8: 60_release_plan.md ã®å­˜åœ¨ï¼ˆé«˜ãƒªã‚¹ã‚¯ï¼‰
    # ========================================
    ((total++))
    echo ""
    print_info "[8/8] 60_release_plan.md ã®ç¢ºèª..."

    if [[ "$RISK_LEVEL" == "high" ]]; then
        if [[ -f "${feature_dir}/60_release_plan.md" ]] && [[ -s "${feature_dir}/60_release_plan.md" ]]; then
            print_success "60_release_plan.md å­˜åœ¨"
            ((passed++))
        else
            print_error "60_release_plan.md ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆHigh Risk ã§ã¯å¿…é ˆï¼‰"
            ((errors++))
        fi
    else
        print_info "  â†’ Low/Medium Risk ã®ãŸã‚ãƒªãƒªãƒ¼ã‚¹è¨ˆç”»ã¯ä¸è¦"
        ((passed++))
    fi

    # ========================================
    # Summary
    # ========================================
    echo ""
    print_header "æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼"

    echo "æ²»ç†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:"
    echo "  âœ“ åˆæ ¼: ${passed}/${total}"
    echo "  âš  è­¦å‘Š: ${warnings}"
    echo "  âœ— å¤±æ•—: ${errors}"
    echo ""

    if [[ $errors -eq 0 ]] && [[ $warnings -eq 0 ]]; then
        print_success "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ ğŸ‰"
        echo ""
        print_info "æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
        if [[ "$STATUS" == "planning" ]]; then
            echo "  1. /sdlc-pr-design ${feature_id} ã§ Design Review PR ã‚’ä½œæˆ"
        elif [[ "$STATUS" == "designing" ]]; then
            echo "  1. Design Review ã‚’å®Œäº†"
            echo "  2. /sdlc-decision ${feature_id} ã§ Decision ã‚’ç¢ºå®š"
        elif [[ "$STATUS" == "implementing" ]]; then
            echo "  1. /sdlc-check ${feature_id} ã§å®Ÿè£…ã‚’æ¤œè¨¼"
            echo "  2. /sdlc-pr-code ${feature_id} ã§ Implementation PR ã‚’ä½œæˆ"
        fi
        return 0
    elif [[ $errors -eq 0 ]]; then
        print_warning "è­¦å‘ŠãŒã‚ã‚Šã¾ã™ãŒã€ç¶šè¡Œå¯èƒ½ã§ã™"
        echo ""
        print_info "è­¦å‘Šã‚’è§£æ±ºã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™"
        return 0
    else
        print_error "å¿…é ˆãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
        echo ""
        print_info "ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„"
        return 1
    fi
}

# Check feature completeness
check_feature() {
    local feature_id=$1

    if [[ -z "$feature_id" ]]; then
        print_error "Feature IDãŒå¿…è¦ã§ã™"
        exit 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    print_header "Feature ${feature_id} ã®ãƒã‚§ãƒƒã‚¯"

    source "${feature_dir}/.metadata"

    local errors=0

    print_info "å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

    local required_files=("00_context.md" "decisions.md" "risks.md")

    if [[ "$RISK_LEVEL" == "medium" ]] || [[ "$RISK_LEVEL" == "high" ]]; then
        required_files+=("10_requirements.md" "20_design.md" "50_test_plan.md")
    fi

    if [[ "$RISK_LEVEL" == "high" ]]; then
        required_files+=("30_implementation_plan.md" "60_release_plan.md")
    fi

    for file in "${required_files[@]}"; do
        if [[ ! -f "${feature_dir}/${file}" ]]; then
            print_error "å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${file}"
            ((errors++))
        elif [[ ! -s "${feature_dir}/${file}" ]]; then
            print_warning "${file} ãŒç©ºã§ã™"
        else
            print_success "${file} OK"
        fi
    done

    echo ""

    if [[ $errors -eq 0 ]]; then
        print_success "ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
        return 0
    else
        print_error "${errors}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
        return 1
    fi
}

# List all features
list_features() {
    print_header "å…¨Featureä¸€è¦§"

    if [[ ! -d "$FEATURES_DIR" ]] || [[ -z "$(ls -A "$FEATURES_DIR" 2>/dev/null)" ]]; then
        print_info "FeatureãŒã¾ã ã‚ã‚Šã¾ã›ã‚“"
        echo "æ–°ã—ã„Featureã‚’ä½œæˆ: Claude Codeå†…ã§ /sdlc-init <github-issue-url>"
        return
    fi

    printf "%-20s %-10s %-15s %-12s %s\n" "FEATURE ID" "RISK" "STATUS" "DECISION" "CREATED"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ -d "$feature_dir" ]] && [[ -f "${feature_dir}/.metadata" ]]; then
            source "${feature_dir}/.metadata"

            local feature_name=$(basename "$feature_dir")

            printf "%-20s %-10s %-15s %-12s %s\n" \
                "$feature_name" \
                "$RISK_LEVEL" \
                "$STATUS" \
                "$DECISION_STATUS" \
                "$CREATED_DATE"
        fi
    done
}

# Update decision status
update_decision() {
    local feature_id=$1
    local decision_status=$2

    if [[ -z "$feature_id" ]] || [[ -z "$decision_status" ]]; then
        print_error "Feature IDã¨Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¿…è¦ã§ã™"
        echo "ä½¿ç”¨æ–¹æ³•: sdlc-cli decision <feature-id> <pending|confirmed|revised>"
        exit 1
    fi

    if [[ ! "$decision_status" =~ ^(pending|confirmed|revised)$ ]]; then
        print_error "Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ pending, confirmed, revised ã®ã„ãšã‚Œã‹ã§ã™"
        exit 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    sed -i.bak "s/DECISION_STATUS=.*/DECISION_STATUS=${decision_status}/" "${feature_dir}/.metadata"
    rm -f "${feature_dir}/.metadata.bak"

    print_success "Feature ${feature_id} ã®Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ ${decision_status} ã«æ›´æ–°"

    if [[ "$decision_status" == "confirmed" ]]; then
        print_success "å®Ÿè£…ã‚’é–‹å§‹ã§ãã¾ã™ï¼"
    fi
}

# Update risk level
update_risk() {
    local feature_id=$1
    local risk_level=$2

    if [[ -z "$feature_id" ]] || [[ -z "$risk_level" ]]; then
        print_error "Feature IDã¨ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ãŒå¿…è¦ã§ã™"
        echo "ä½¿ç”¨æ–¹æ³•: sdlc-cli risk <feature-id> <low|medium|high>"
        exit 1
    fi

    if [[ ! "$risk_level" =~ ^(low|medium|high)$ ]]; then
        print_error "ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã¯ low, medium, high ã®ã„ãšã‚Œã‹ã§ã™"
        exit 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    source "${feature_dir}/.metadata"
    local old_risk=$RISK_LEVEL

    sed -i.bak "s/RISK_LEVEL=.*/RISK_LEVEL=${risk_level}/" "${feature_dir}/.metadata"
    rm -f "${feature_dir}/.metadata.bak"

    print_success "ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã‚’ ${old_risk} ã‹ã‚‰ ${risk_level} ã«æ›´æ–°"

    if [[ "$risk_level" == "medium" ]] || [[ "$risk_level" == "high" ]]; then
        if [[ ! -f "${feature_dir}/20_design.md" ]]; then
            print_warning "ä¸­/é«˜ãƒªã‚¹ã‚¯ã«ã¯è¨­è¨ˆæ–‡æ›¸ãŒæ¨å¥¨ã•ã‚Œã¾ã™"
        fi
    fi

    if [[ "$risk_level" == "high" ]]; then
        if [[ ! -f "${feature_dir}/30_implementation_plan.md" ]]; then
            print_warning "é«˜ãƒªã‚¹ã‚¯ã«ã¯å®Ÿè£…è¨ˆç”»ãŒå¿…è¦ã§ã™"
        fi
    fi
}

# Generate report (Management Overview)
generate_report() {
    print_header "SDLC ç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆ"

    if [[ ! -d "$FEATURES_DIR" ]] || [[ -z "$(ls -A "$FEATURES_DIR" 2>/dev/null)" ]]; then
        print_info "FeatureãŒã¾ã ã‚ã‚Šã¾ã›ã‚“"
        return
    fi

    # ========================================
    # çµ±è¨ˆãƒ‡ãƒ¼ã‚¿åé›†
    # ========================================
    local total=0
    local low_risk=0
    local medium_risk=0
    local high_risk=0
    local confirmed=0
    local planning=0
    local designing=0
    local implementing=0
    local completed=0
    local blocked=0
    local revision_count=0
    local total_risks=0
    local high_priority_risks=0

    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ -d "$feature_dir" ]] && [[ -f "${feature_dir}/.metadata" ]]; then
            source "${feature_dir}/.metadata"
            ((total++))

            # Risk Level
            case "$RISK_LEVEL" in
                low) ((low_risk++)) ;;
                medium) ((medium_risk++)) ;;
                high) ((high_risk++)) ;;
            esac

            # Decision Status
            if [[ "$DECISION_STATUS" == "confirmed" ]]; then
                ((confirmed++))
            fi

            # Phase
            case "$STATUS" in
                planning) ((planning++)) ;;
                designing) ((designing++)) ;;
                implementing) ((implementing++)) ;;
                completed) ((completed++)) ;;
                blocked) ((blocked++)) ;;
            esac

            # Revisions
            if [[ -f "${feature_dir}/decisions.md" ]]; then
                local revisions=$(grep -c "^## Decision Revision" "${feature_dir}/decisions.md" 2>/dev/null || echo "0")
                revision_count=$((revision_count + revisions))
            fi

            # Risks
            if [[ -f "${feature_dir}/risks.md" ]]; then
                local risks=$(grep -c "^## Risk" "${feature_dir}/risks.md" 2>/dev/null || echo "0")
                total_risks=$((total_risks + risks))

                local high_risks=$(grep -E "Risk Level.*: High" "${feature_dir}/risks.md" 2>/dev/null | wc -l | xargs)
                high_priority_risks=$((high_priority_risks + high_risks))
            fi
        fi
    done

    # ========================================
    # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
    # ========================================
    echo "ğŸ“Š Feature ã‚µãƒãƒªãƒ¼"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  ç·Featureæ•°:         ${total}"
    echo "  å®Œäº†:                ${completed}"
    echo "  å®Ÿè£…ä¸­:              ${implementing}"
    echo "  è¨­è¨ˆä¸­:              ${designing}"
    echo "  è¨ˆç”»ä¸­:              ${planning}"
    if [[ $blocked -gt 0 ]]; then
        echo -e "  ${RED}ãƒ–ãƒ­ãƒƒã‚¯ä¸­:          ${blocked}${NC}"
    fi
    echo ""

    # ========================================
    # ãƒªã‚¹ã‚¯åˆ†å¸ƒ
    # ========================================
    echo "âš ï¸  ãƒªã‚¹ã‚¯åˆ†å¸ƒ"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  Low Risk:            ${low_risk}"
    echo "  Medium Risk:         ${medium_risk}"
    if [[ $high_risk -gt 0 ]]; then
        echo -e "  ${YELLOW}High Risk:           ${high_risk}${NC}"
    else
        echo "  High Risk:           ${high_risk}"
    fi
    echo ""
    echo "  ç·ãƒªã‚¹ã‚¯è¨˜éŒ²æ•°:      ${total_risks}"
    if [[ $high_priority_risks -gt 0 ]]; then
        echo -e "  ${RED}High å„ªå…ˆåº¦ãƒªã‚¹ã‚¯:   ${high_priority_risks}${NC}"
    else
        echo "  High å„ªå…ˆåº¦ãƒªã‚¹ã‚¯:   ${high_priority_risks}"
    fi
    echo ""

    # ========================================
    # æ²»ç†ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    # ========================================
    echo "ğŸ” æ²»ç†ãƒ¡ãƒˆãƒªã‚¯ã‚¹"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "  Decision ç¢ºå®šæ¸ˆã¿:   ${confirmed}/${total}"

    local decision_rate=0
    if [[ $total -gt 0 ]]; then
        decision_rate=$((confirmed * 100 / total))
    fi

    if [[ $decision_rate -ge 80 ]]; then
        echo -e "  ${GREEN}Decision ç¢ºå®šç‡:     ${decision_rate}%${NC}"
    elif [[ $decision_rate -ge 50 ]]; then
        echo -e "  ${YELLOW}Decision ç¢ºå®šç‡:     ${decision_rate}%${NC}"
    else
        echo -e "  ${RED}Decision ç¢ºå®šç‡:     ${decision_rate}%${NC}"
    fi

    echo "  Decision Revision:   ${revision_count}ä»¶"

    if [[ $revision_count -gt 0 ]]; then
        local avg_revision=$(echo "scale=1; $revision_count / $total" | bc)
        if (( $(echo "$avg_revision > 2" | bc -l) )); then
            echo -e "  ${RED}å¹³å‡ Revision/Feature: ${avg_revision}${NC} (è¦æ³¨æ„)"
        elif (( $(echo "$avg_revision > 1" | bc -l) )); then
            echo -e "  ${YELLOW}å¹³å‡ Revision/Feature: ${avg_revision}${NC}"
        else
            echo -e "  ${GREEN}å¹³å‡ Revision/Feature: ${avg_revision}${NC}"
        fi
    fi
    echo ""

    # ========================================
    # å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
    # ========================================
    echo "âœ… ãƒ—ãƒ­ã‚»ã‚¹å¥å…¨æ€§"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    local health_issues=0

    # Check 1: Feature ã« Issue URL ãŒã‚ã‚‹ã‹
    local features_with_issue=0
    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ -d "$feature_dir" ]] && [[ -f "${feature_dir}/.metadata" ]]; then
            source "${feature_dir}/.metadata"
            if [[ -n "$ISSUE_URL" ]] && [[ "$ISSUE_URL" != "https://github.com/owner/repo/issues/" ]]; then
                ((features_with_issue++))
            fi
        fi
    done

    local issue_rate=$((features_with_issue * 100 / total))
    if [[ $issue_rate -ge 90 ]]; then
        echo -e "  ${GREEN}âœ“${NC} Issue URL è¨­å®šç‡: ${issue_rate}%"
    else
        echo -e "  ${YELLOW}âš ${NC} Issue URL è¨­å®šç‡: ${issue_rate}% (Iron Rule 1 é•åã®å¯èƒ½æ€§)"
        ((health_issues++))
    fi

    # Check 2: Decision ç¢ºå®šç‡
    if [[ $decision_rate -ge 80 ]]; then
        echo -e "  ${GREEN}âœ“${NC} Decision ç¢ºå®šç‡: ${decision_rate}%"
    else
        echo -e "  ${YELLOW}âš ${NC} Decision ç¢ºå®šç‡: ${decision_rate}% (Iron Rule 2 æº–æ‹ ã‚’ç¢ºèª)"
        ((health_issues++))
    fi

    # Check 3: Risk è¨˜éŒ²ç‡
    local features_with_risks=0
    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ -d "$feature_dir" ]] && [[ -f "${feature_dir}/risks.md" ]]; then
            local risks=$(grep -c "^## Risk" "${feature_dir}/risks.md" 2>/dev/null || echo "0")
            if [[ $risks -gt 0 ]]; then
                ((features_with_risks++))
            fi
        fi
    done

    local risk_rate=$((features_with_risks * 100 / total))
    if [[ $risk_rate -ge 90 ]]; then
        echo -e "  ${GREEN}âœ“${NC} Risk è¨˜éŒ²ç‡: ${risk_rate}%"
    else
        echo -e "  ${YELLOW}âš ${NC} Risk è¨˜éŒ²ç‡: ${risk_rate}% (Iron Rule 3 é•åã®å¯èƒ½æ€§)"
        ((health_issues++))
    fi

    # Check 4: Revision é »åº¦
    if [[ $total -gt 0 ]]; then
        local avg_revision=$(echo "scale=1; $revision_count / $total" | bc)
        if (( $(echo "$avg_revision <= 1.5" | bc -l) )); then
            echo -e "  ${GREEN}âœ“${NC} Revision é »åº¦: æ­£å¸¸ç¯„å›²"
        else
            echo -e "  ${YELLOW}âš ${NC} Revision é »åº¦: é«˜ã‚ (è¨­è¨ˆå“è³ªã®è¦‹ç›´ã—ã‚’æ¨å¥¨)"
            ((health_issues++))
        fi
    fi

    echo ""

    if [[ $health_issues -eq 0 ]]; then
        print_success "ãƒ—ãƒ­ã‚»ã‚¹ã¯å¥å…¨ã§ã™ ğŸ‰"
    else
        print_warning "${health_issues}ä»¶ã®å¥å…¨æ€§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
    fi

    echo ""

    # ========================================
    # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    # ========================================
    print_info "æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"

    if [[ $planning -gt 0 ]]; then
        echo "  â†’ ${planning}ä»¶ã® Feature ãŒè¨ˆç”»ä¸­ï¼ˆDesign Review ã‚’é€²ã‚ã‚‹ï¼‰"
    fi

    if [[ $designing -gt 0 ]]; then
        echo "  â†’ ${designing}ä»¶ã® Feature ãŒè¨­è¨ˆä¸­ï¼ˆDecision ç¢ºå®šã‚’é€²ã‚ã‚‹ï¼‰"
    fi

    if [[ $blocked -gt 0 ]]; then
        echo -e "  ${RED}â†’ ${blocked}ä»¶ã® Feature ãŒãƒ–ãƒ­ãƒƒã‚¯ä¸­ï¼ˆå„ªå…ˆçš„ã«è§£æ±ºï¼‰${NC}"
    fi

    if [[ $issue_rate -lt 90 ]]; then
        echo "  â†’ Issue URL ãŒæœªè¨­å®šã® Feature ã‚’ç¢ºèª"
    fi

    if [[ $risk_rate -lt 90 ]]; then
        echo "  â†’ ãƒªã‚¹ã‚¯ãŒæœªè¨˜éŒ²ã® Feature ã‚’ç¢ºèª"
    fi

    echo ""
    print_info "è©³ç´°: 'sdlc-cli list' ã¾ãŸã¯ 'sdlc-cli status <feature-id>'"
}

# Main
main() {
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    local command=$1
    shift

    case "$command" in
        status)
            show_status "$@"
            ;;
        check)
            check_feature "$@"
            ;;
        validate)
            validate_feature "$@"
            ;;
        list)
            list_features
            ;;
        decision)
            update_decision "$@"
            ;;
        risk)
            update_risk "$@"
            ;;
        report)
            generate_report
            ;;
        version)
            echo "SDLC CLI version ${VERSION}"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: ${command}"
            echo "ä½¿ç”¨æ–¹æ³•: sdlc-cli help"
            exit 1
            ;;
    esac
}

main "$@"
