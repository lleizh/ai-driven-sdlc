#!/usr/bin/env bash

# SDLC CLI Tool
# AI-Driven SDLC ç®¡ç†å·¥å…·ï¼ˆç²¾ç°¡ç‰ˆï¼‰
# å†…å®¹ç”Ÿæˆã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Claude Code slash commandsã‚’ä½¿ç”¨

set -e

VERSION="2.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SDLC_DIR="${SCRIPT_DIR}/sdlc"
TEMPLATES_DIR="${SDLC_DIR}/templates"
FEATURES_DIR="${SDLC_DIR}/features"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_info() {
    echo -e "${BLUE}â„¹${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

print_header() {
    echo -e "\n${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

show_help() {
    cat << EOF
SDLC CLI v${VERSION} - ç®¡ç†ãƒ„ãƒ¼ãƒ«

ğŸ“ Featureä½œæˆã¯Claude Code slash commandã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„:
   /sdlc-init <github-issue-url> - GitHub Issueã‹ã‚‰Featureæ–‡æ›¸ã‚’è‡ªå‹•ç”Ÿæˆ

ğŸ”§ ã“ã®CLIã¯ä»¥ä¸‹ã®ç®¡ç†æ©Ÿèƒ½ã‚’æä¾›:

åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰:
  list                              å…¨Featureã®ä¸€è¦§è¡¨ç¤º

  status <feature-id>               Featureã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º

çŠ¶æ…‹ç®¡ç†:
  decision <feature-id> <status>    Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´
                                    status: pending|confirmed|revised

  risk <feature-id> <level>         ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã‚’å¤‰æ›´
                                    level: low|medium|high

æ¤œè¨¼ï¼ˆCI/CDç”¨ï¼‰:
  validate <feature-id>             Decisionã¨Riskã®æ¤œè¨¼

  check <feature-id>                å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯

ãƒ¬ãƒãƒ¼ãƒˆ:
  report                            çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

  version                           ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º

  help                              ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¾‹:
  # 1. GitHubã§Issueã‚’ä½œæˆï¼ˆfeature.mdãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½¿ç”¨ï¼‰

  # 2. Claude Codeã§æ–‡æ›¸ã‚’è‡ªå‹•ç”Ÿæˆ
  # Claude Codeå†…ã§: /sdlc-init https://github.com/owner/repo/issues/123

  # 3. ç”Ÿæˆã•ã‚ŒãŸæ–‡æ›¸ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»èª¿æ•´

  # 4. Decisionã‚’ç¢ºå®š
  sdlc-cli decision FEATURE-123 confirmed

  # 5. å®Ÿè£…å‰ã«æ¤œè¨¼
  sdlc-cli validate FEATURE-123

  # 6. å®Ÿè£…é–‹å§‹
  git checkout -b feature/FEATURE-123

è©³ç´°: https://github.com/yourusername/ai-driven-sdlc

EOF
}



# Show feature status
show_status() {
    local feature_id=$1

    if [[ -z "$feature_id" ]]; then
        print_error "Feature IDãŒå¿…è¦ã§ã™"
        exit 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    print_header "Feature ${feature_id} ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"

    source "${feature_dir}/.metadata"

    echo "åŸºæœ¬æƒ…å ±:"
    echo "  Feature ID:         ${feature_id}"
    echo "  ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«:       ${RISK_LEVEL}"
    echo "  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:         ${STATUS}"
    echo "  ä½œæˆæ—¥:             ${CREATED_DATE}"
    echo "  Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${DECISION_STATUS}"
    echo ""

    echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:"
    for doc in "${feature_dir}"/*.md; do
        if [[ -f "$doc" ]]; then
            local doc_name=$(basename "$doc")
            local line_count=$(wc -l < "$doc" | xargs)
            local status_icon="â—‹"

            if [[ $line_count -gt 10 ]]; then
                status_icon="${GREEN}âœ“${NC}"
            elif [[ $line_count -gt 0 ]]; then
                status_icon="${YELLOW}â—${NC}"
            fi

            echo -e "  ${status_icon} ${doc_name} (${line_count} lines)"
        fi
    done
    echo ""

    if [[ "$DECISION_STATUS" == "confirmed" ]]; then
        print_success "å®Ÿè£…é–‹å§‹å¯èƒ½ (Decision CONFIRMED)"
    else
        print_warning "å®Ÿè£…é–‹å§‹ä¸å¯ (Decision ãŒ ${DECISION_STATUS})"
    fi
}

# Validate feature
validate_feature() {
    local feature_id=$1

    if [[ -z "$feature_id" ]]; then
        print_error "Feature IDãŒå¿…è¦ã§ã™"
        exit 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    print_header "Feature ${feature_id} ã®æ¤œè¨¼"

    source "${feature_dir}/.metadata"

    local errors=0

    print_info "Decisionã‚’æ¤œè¨¼ä¸­..."

    if grep -q "Status.*: CONFIRMED" "${feature_dir}/decisions.md" 2>/dev/null; then
        print_success "DecisionãŒCONFIRMEDã§ã™"

        # Update metadata
        sed -i.bak 's/DECISION_STATUS=.*/DECISION_STATUS=confirmed/' "${feature_dir}/.metadata"
        rm -f "${feature_dir}/.metadata.bak"

        print_success "å®Ÿè£…ã‚’é–‹å§‹ã§ãã¾ã™"
    else
        print_error "DecisionãŒCONFIRMEDã§ã¯ã‚ã‚Šã¾ã›ã‚“"
        print_info "decisions.mdã§Statusã‚’CONFIRMEDã«ã—ã¦ãã ã•ã„"
        ((errors++))
    fi

    echo ""
    print_info "Riskã‚’æ¤œè¨¼ä¸­..."

    if [[ -s "${feature_dir}/risks.md" ]]; then
        local risk_count=$(grep -c "Risk R[0-9]" "${feature_dir}/risks.md" 2>/dev/null || echo "0")
        if [[ $risk_count -gt 0 ]]; then
            print_success "${risk_count}å€‹ã®ãƒªã‚¹ã‚¯ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã™"
        else
            print_warning "ãƒªã‚¹ã‚¯ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“"
        fi
    else
        print_warning "risks.mdãŒç©ºã§ã™"
    fi

    echo ""

    if [[ $errors -eq 0 ]]; then
        print_success "æ¤œè¨¼å®Œäº†"
        return 0
    else
        print_error "æ¤œè¨¼å¤±æ•—"
        return 1
    fi
}

# Check feature completeness
check_feature() {
    local feature_id=$1

    if [[ -z "$feature_id" ]]; then
        print_error "Feature IDãŒå¿…è¦ã§ã™"
        exit 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    print_header "Feature ${feature_id} ã®ãƒã‚§ãƒƒã‚¯"

    source "${feature_dir}/.metadata"

    local errors=0

    print_info "å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

    local required_files=("00_context.md" "decisions.md" "risks.md")

    if [[ "$RISK_LEVEL" == "medium" ]] || [[ "$RISK_LEVEL" == "high" ]]; then
        required_files+=("10_requirements.md" "20_design.md" "50_test_plan.md")
    fi

    if [[ "$RISK_LEVEL" == "high" ]]; then
        required_files+=("30_implementation_plan.md" "60_release_plan.md")
    fi

    for file in "${required_files[@]}"; do
        if [[ ! -f "${feature_dir}/${file}" ]]; then
            print_error "å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${file}"
            ((errors++))
        elif [[ ! -s "${feature_dir}/${file}" ]]; then
            print_warning "${file} ãŒç©ºã§ã™"
        else
            print_success "${file} OK"
        fi
    done

    echo ""

    if [[ $errors -eq 0 ]]; then
        print_success "ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
        return 0
    else
        print_error "${errors}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
        return 1
    fi
}

# List all features
list_features() {
    print_header "å…¨Featureä¸€è¦§"

    if [[ ! -d "$FEATURES_DIR" ]] || [[ -z "$(ls -A "$FEATURES_DIR" 2>/dev/null)" ]]; then
        print_info "FeatureãŒã¾ã ã‚ã‚Šã¾ã›ã‚“"
        echo "æ–°ã—ã„Featureã‚’ä½œæˆ: Claude Codeå†…ã§ /sdlc-init <github-issue-url>"
        return
    fi

    printf "%-20s %-10s %-15s %-12s %s\n" "FEATURE ID" "RISK" "STATUS" "DECISION" "CREATED"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ -d "$feature_dir" ]] && [[ -f "${feature_dir}/.metadata" ]]; then
            source "${feature_dir}/.metadata"

            local feature_name=$(basename "$feature_dir")

            printf "%-20s %-10s %-15s %-12s %s\n" \
                "$feature_name" \
                "$RISK_LEVEL" \
                "$STATUS" \
                "$DECISION_STATUS" \
                "$CREATED_DATE"
        fi
    done
}

# Update decision status
update_decision() {
    local feature_id=$1
    local decision_status=$2

    if [[ -z "$feature_id" ]] || [[ -z "$decision_status" ]]; then
        print_error "Feature IDã¨Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¿…è¦ã§ã™"
        echo "ä½¿ç”¨æ–¹æ³•: sdlc-cli decision <feature-id> <pending|confirmed|revised>"
        exit 1
    fi

    if [[ ! "$decision_status" =~ ^(pending|confirmed|revised)$ ]]; then
        print_error "Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ pending, confirmed, revised ã®ã„ãšã‚Œã‹ã§ã™"
        exit 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    sed -i.bak "s/DECISION_STATUS=.*/DECISION_STATUS=${decision_status}/" "${feature_dir}/.metadata"
    rm -f "${feature_dir}/.metadata.bak"

    print_success "Feature ${feature_id} ã®Decisionã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ ${decision_status} ã«æ›´æ–°"

    if [[ "$decision_status" == "confirmed" ]]; then
        print_success "å®Ÿè£…ã‚’é–‹å§‹ã§ãã¾ã™ï¼"
    fi
}

# Update risk level
update_risk() {
    local feature_id=$1
    local risk_level=$2

    if [[ -z "$feature_id" ]] || [[ -z "$risk_level" ]]; then
        print_error "Feature IDã¨ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ãŒå¿…è¦ã§ã™"
        echo "ä½¿ç”¨æ–¹æ³•: sdlc-cli risk <feature-id> <low|medium|high>"
        exit 1
    fi

    if [[ ! "$risk_level" =~ ^(low|medium|high)$ ]]; then
        print_error "ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã¯ low, medium, high ã®ã„ãšã‚Œã‹ã§ã™"
        exit 1
    fi

    local feature_dir="${FEATURES_DIR}/${feature_id}"

    if [[ ! -d "$feature_dir" ]]; then
        print_error "Feature ${feature_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi

    source "${feature_dir}/.metadata"
    local old_risk=$RISK_LEVEL

    sed -i.bak "s/RISK_LEVEL=.*/RISK_LEVEL=${risk_level}/" "${feature_dir}/.metadata"
    rm -f "${feature_dir}/.metadata.bak"

    print_success "ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã‚’ ${old_risk} ã‹ã‚‰ ${risk_level} ã«æ›´æ–°"

    if [[ "$risk_level" == "medium" ]] || [[ "$risk_level" == "high" ]]; then
        if [[ ! -f "${feature_dir}/20_design.md" ]]; then
            print_warning "ä¸­/é«˜ãƒªã‚¹ã‚¯ã«ã¯è¨­è¨ˆæ–‡æ›¸ãŒæ¨å¥¨ã•ã‚Œã¾ã™"
        fi
    fi

    if [[ "$risk_level" == "high" ]]; then
        if [[ ! -f "${feature_dir}/30_implementation_plan.md" ]]; then
            print_warning "é«˜ãƒªã‚¹ã‚¯ã«ã¯å®Ÿè£…è¨ˆç”»ãŒå¿…è¦ã§ã™"
        fi
    fi
}

# Generate report
generate_report() {
    print_header "SDLCãƒ¬ãƒãƒ¼ãƒˆ"

    if [[ ! -d "$FEATURES_DIR" ]] || [[ -z "$(ls -A "$FEATURES_DIR" 2>/dev/null)" ]]; then
        print_info "FeatureãŒã¾ã ã‚ã‚Šã¾ã›ã‚“"
        return
    fi

    local total=0
    local low_risk=0
    local medium_risk=0
    local high_risk=0
    local confirmed=0

    for feature_dir in "${FEATURES_DIR}"/*; do
        if [[ -d "$feature_dir" ]] && [[ -f "${feature_dir}/.metadata" ]]; then
            source "${feature_dir}/.metadata"
            ((total++))

            case "$RISK_LEVEL" in
                low) ((low_risk++)) ;;
                medium) ((medium_risk++)) ;;
                high) ((high_risk++)) ;;
            esac

            if [[ "$DECISION_STATUS" == "confirmed" ]]; then
                ((confirmed++))
            fi
        fi
    done

    echo "çµ±è¨ˆ:"
    echo "  ç·Featureæ•°:        ${total}"
    echo "  ä½ãƒªã‚¹ã‚¯:           ${low_risk}"
    echo "  ä¸­ãƒªã‚¹ã‚¯:           ${medium_risk}"
    echo "  é«˜ãƒªã‚¹ã‚¯:           ${high_risk}"
    echo "  Decisionç¢ºå®šæ¸ˆã¿:   ${confirmed}"
    echo ""

    print_info "è©³ç´°ã¯ 'sdlc-cli list' ã§ç¢ºèª"
}

# Main
main() {
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    local command=$1
    shift

    case "$command" in
        status)
            show_status "$@"
            ;;
        check)
            check_feature "$@"
            ;;
        validate)
            validate_feature "$@"
            ;;
        list)
            list_features
            ;;
        decision)
            update_decision "$@"
            ;;
        risk)
            update_risk "$@"
            ;;
        report)
            generate_report
            ;;
        version)
            echo "SDLC CLI version ${VERSION}"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: ${command}"
            echo "ä½¿ç”¨æ–¹æ³•: sdlc-cli help"
            exit 1
            ;;
    esac
}

main "$@"
