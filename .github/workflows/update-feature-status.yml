name: Update Feature Status on Merge

on:
  push:
    branches:
      - develop

jobs:
  update-status:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨æ¯”è¼ƒã™ã‚‹ãŸã‚

      - name: Extract Feature ID from merge commit
        id: extract
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
          COMMIT_SHA="${{ github.sha }}"
          COMMITTER=$(git log -1 --pretty=%cn "$COMMIT_SHA")

          echo "Commit SHA: $COMMIT_SHA"
          echo "Committer: $COMMITTER"

          # Committer ãŒ "GitHub" ã§ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆPR ãƒãƒ¼ã‚¸ã§ã¯ãªã„ï¼‰
          if [[ "$COMMITTER" != "GitHub" ]]; then
            echo "âš ï¸ Committer ãŒ 'GitHub' ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚PR ãƒãƒ¼ã‚¸ã§ã¯ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "is_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ“ Committer ãŒ 'GitHub' ã§ã™ã€‚PR ãƒãƒ¼ã‚¸ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"

          # GitHub API ã‚’ä½¿ç”¨ã—ã¦ commit ã«é–¢é€£ã™ã‚‹ PR ã‚’å–å¾—
          echo "GitHub API ã§ PR æƒ…å ±ã‚’å–å¾—ä¸­..."
          PR_DATA=$(gh api "/repos/${{ github.repository }}/commits/$COMMIT_SHA/pulls" \
            --jq '.[0] | {number: .number, head_ref: .head.ref}' 2>&1)

          if [[ $? -ne 0 ]]; then
            echo "âš ï¸ GitHub API å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: $PR_DATA"
            echo "âš ï¸ PR æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "is_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PR ãŒå­˜åœ¨ã—ãªã„å ´åˆ
          if [[ -z "$PR_DATA" || "$PR_DATA" == "null" ]]; then
            echo "âš ï¸ ã“ã® commit ã«é–¢é€£ã™ã‚‹ PR ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "is_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PR æƒ…å ±ã‚’æŠ½å‡º
          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
          PR_HEAD_REF=$(echo "$PR_DATA" | jq -r '.head_ref')

          echo "âœ“ PR #$PR_NUMBER ã‚’æ¤œå‡º"
          echo "âœ“ Head ãƒ–ãƒ©ãƒ³ãƒ: $PR_HEAD_REF"

          # Strict pattern ã§ feature ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯: ^feature/FEATURE-[0-9]+$
          if [[ $PR_HEAD_REF =~ ^feature/(FEATURE-[0-9]+)$ ]]; then
            FEATURE_ID="${BASH_REMATCH[1]}"
            echo "âœ“ Feature ID ã‚’æŠ½å‡º: $FEATURE_ID"
            echo "is_merge=true" >> $GITHUB_OUTPUT
            echo "feature_id=$FEATURE_ID" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ feature ãƒ–ãƒ©ãƒ³ãƒã§ã¯ã‚ã‚Šã¾ã›ã‚“: $PR_HEAD_REF"
            echo "âš ï¸ æœŸå¾…ã•ã‚Œã‚‹å½¢å¼: feature/FEATURE-[0-9]+ (ä¾‹: feature/FEATURE-19)"
            echo "is_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Update metadata STATUS
        if: steps.extract.outputs.is_merge == 'true'
        run: |
          FEATURE_ID="${{ steps.extract.outputs.feature_id }}"
          METADATA_FILE="sdlc/features/$FEATURE_ID/.metadata"

          echo "=========================================="
          echo "Feature STATUS ã‚’æ›´æ–°ä¸­: $FEATURE_ID"
          echo "=========================================="

          # .metadata ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [[ ! -f "$METADATA_FILE" ]]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: .metadata ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "âŒ ãƒ‘ã‚¹: $METADATA_FILE"
            echo ""
            echo "ğŸ“‹ æ‰‹å‹•ãƒªã‚«ãƒãƒªãƒ¼æ‰‹é †:"
            echo "1. $METADATA_FILE ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª"
            echo "2. å­˜åœ¨ã—ãªã„å ´åˆã¯ /sdlc-init ã§ Feature ã‚’åˆæœŸåŒ–"
            echo "3. å­˜åœ¨ã™ã‚‹å ´åˆã¯æ‰‹å‹•ã§ STATUS ã‚’ completed ã«æ›´æ–°"
            exit 1
          fi

          echo "âœ“ .metadata ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª"

          # ç¾åœ¨ã® STATUS ã‚’ç¢ºèª
          CURRENT_STATUS=$(grep "^STATUS=" "$METADATA_FILE" | cut -d= -f2)
          echo "ç¾åœ¨ã® STATUS: $CURRENT_STATUS"

          # STATUS ãŒ review ã§ãªã„å ´åˆã¯è­¦å‘Š
          if [[ "$CURRENT_STATUS" != "review" ]]; then
            echo "âš ï¸ è­¦å‘Š: STATUS ãŒ review ã§ã¯ã‚ã‚Šã¾ã›ã‚“ (ç¾åœ¨: $CURRENT_STATUS)"
            echo "âš ï¸ completed ã¸ã®æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            echo ""
            echo "ğŸ“‹ äºˆæƒ³ã•ã‚Œã‚‹åŸå› :"
            echo "- Feature ãŒã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼æ®µéšã«é”ã—ã¦ã„ãªã„ (STATUS=planning, design, implementing, testing)"
            echo "- ã™ã§ã« completed ã«æ›´æ–°æ¸ˆã¿"
            echo "- æ‰‹å‹•ã§ STATUS ãŒå¤‰æ›´ã•ã‚ŒãŸ"
            exit 0
          fi

          # STATUS ã‚’ review â†’ completed ã«æ›´æ–°
          # awk ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ã‚¿ãƒ–ãƒ«ã«å®Ÿè£…
          awk '{if ($0 ~ /^STATUS=review$/) print "STATUS=completed"; else print}' "$METADATA_FILE" > "$METADATA_FILE.tmp"
          mv "$METADATA_FILE.tmp" "$METADATA_FILE"

          # æ›´æ–°ã‚’ç¢ºèª
          NEW_STATUS=$(grep "^STATUS=" "$METADATA_FILE" | cut -d= -f2)

          if [[ "$NEW_STATUS" != "completed" ]]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: STATUS ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "âŒ æ›´æ–°å¾Œã® STATUS: $NEW_STATUS"
            exit 1
          fi

          echo "âœ“ STATUS ã‚’æ›´æ–°: $CURRENT_STATUS â†’ $NEW_STATUS"

          # Git ã§å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$METADATA_FILE"
          git commit -m "chore: Mark $FEATURE_ID as completed [skip ci]"

          # develop ã«ãƒ—ãƒƒã‚·ãƒ¥
          echo "å¤‰æ›´ã‚’ develop ã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
          git push origin develop

          echo ""
          echo "=========================================="
          echo "âœ… $FEATURE_ID ã® STATUS ã‚’ completed ã«æ›´æ–°ã—ã¾ã—ãŸ"
          echo "=========================================="
          echo ""
          echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "- sync-projects.yml ãŒè‡ªå‹•çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™"
          echo "- GitHub Projects ã® Status ãŒ 'Done' ã«æ›´æ–°ã•ã‚Œã¾ã™"
