name: Update Feature Status on Merge

on:
  push:
    branches:
      - develop

jobs:
  update-status:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨æ¯”è¼ƒã™ã‚‹ãŸã‚

      - name: Extract Feature ID from merge commit
        id: extract
        run: |
          # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‹ãƒã‚§ãƒƒã‚¯
          if ! git log -1 --pretty=%P | grep -q ' '; then
            echo "âš ï¸ ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "is_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ“ ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã§ã™"

          # ãƒãƒ¼ã‚¸å…ƒã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          # Merge commit ã®2ã¤ç›®ã®è¦ªï¼ˆãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒï¼‰ã‹ã‚‰ãƒ–ãƒ©ãƒ³ãƒåã‚’æ¨å®š
          MERGE_PARENT=$(git log -1 --pretty=%P | awk '{print $2}')

          # git reflog ã‹ã‚‰æœ€è¿‘ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒã‚’æ¢ã™
          # æ³¨: GitHub Actions ã§ã¯é™ã‚‰ã‚ŒãŸæƒ…å ±ã—ã‹å–å¾—ã§ããªã„ãŸã‚ã€
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒ–ãƒ©ãƒ³ãƒåã‚’æŠ½å‡ºã™ã‚‹æ–¹æ³•ã‚’ä½¿ç”¨
          BRANCH_NAME=""

          # ãƒ‘ã‚¿ãƒ¼ãƒ³1: "Merge pull request #123 from owner/feature/FEATURE-19"
          if echo "$COMMIT_MSG" | grep -qE 'Merge pull request.*from.*feature/FEATURE-[0-9]+'; then
            BRANCH_NAME=$(echo "$COMMIT_MSG" | grep -oE 'feature/FEATURE-[0-9]+' | head -1)
          # ãƒ‘ã‚¿ãƒ¼ãƒ³2: "Merge branch 'feature/FEATURE-19' into develop"
          elif echo "$COMMIT_MSG" | grep -qE "Merge branch 'feature/FEATURE-[0-9]+'"; then
            BRANCH_NAME=$(echo "$COMMIT_MSG" | grep -oE "feature/FEATURE-[0-9]+" | head -1)
          fi

          if [[ -z "$BRANCH_NAME" ]]; then
            echo "âš ï¸ feature ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ãƒãƒ¼ã‚¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "is_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ“ ãƒãƒ¼ã‚¸å…ƒãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"

          # Strict pattern ã§ Feature ID ã‚’æŠ½å‡º: ^feature/FEATURE-[0-9]+$
          if [[ $BRANCH_NAME =~ ^feature/(FEATURE-[0-9]+)$ ]]; then
            FEATURE_ID="${BASH_REMATCH[1]}"
            echo "âœ“ Feature ID ã‚’æŠ½å‡º: $FEATURE_ID"
            echo "is_merge=true" >> $GITHUB_OUTPUT
            echo "feature_id=$FEATURE_ID" >> $GITHUB_OUTPUT
          else
            echo "âŒ ãƒ–ãƒ©ãƒ³ãƒåãŒå‘½åè¦å‰‡ã«é•åã—ã¦ã„ã¾ã™: $BRANCH_NAME"
            echo "âŒ æœŸå¾…ã•ã‚Œã‚‹å½¢å¼: feature/FEATURE-[0-9]+ (ä¾‹: feature/FEATURE-19)"
            echo "is_merge=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Update metadata STATUS
        if: steps.extract.outputs.is_merge == 'true'
        run: |
          FEATURE_ID="${{ steps.extract.outputs.feature_id }}"
          METADATA_FILE="sdlc/features/$FEATURE_ID/.metadata"

          echo "=========================================="
          echo "Feature STATUS ã‚’æ›´æ–°ä¸­: $FEATURE_ID"
          echo "=========================================="

          # .metadata ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [[ ! -f "$METADATA_FILE" ]]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: .metadata ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "âŒ ãƒ‘ã‚¹: $METADATA_FILE"
            echo ""
            echo "ğŸ“‹ æ‰‹å‹•ãƒªã‚«ãƒãƒªãƒ¼æ‰‹é †:"
            echo "1. $METADATA_FILE ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª"
            echo "2. å­˜åœ¨ã—ãªã„å ´åˆã¯ /sdlc-init ã§ Feature ã‚’åˆæœŸåŒ–"
            echo "3. å­˜åœ¨ã™ã‚‹å ´åˆã¯æ‰‹å‹•ã§ STATUS ã‚’ completed ã«æ›´æ–°"
            exit 1
          fi

          echo "âœ“ .metadata ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª"

          # ç¾åœ¨ã® STATUS ã‚’ç¢ºèª
          CURRENT_STATUS=$(grep "^STATUS=" "$METADATA_FILE" | cut -d= -f2)
          echo "ç¾åœ¨ã® STATUS: $CURRENT_STATUS"

          # STATUS ãŒ implementing ã§ãªã„å ´åˆã¯è­¦å‘Š
          if [[ "$CURRENT_STATUS" != "implementing" ]]; then
            echo "âš ï¸ è­¦å‘Š: STATUS ãŒ implementing ã§ã¯ã‚ã‚Šã¾ã›ã‚“ (ç¾åœ¨: $CURRENT_STATUS)"
            echo "âš ï¸ completed ã¸ã®æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            echo ""
            echo "ğŸ“‹ äºˆæƒ³ã•ã‚Œã‚‹åŸå› :"
            echo "- Feature ãŒã¾ã å®Ÿè£…é–‹å§‹ã•ã‚Œã¦ã„ãªã„ (STATUS=planning ã¾ãŸã¯ design)"
            echo "- ã™ã§ã« completed ã«æ›´æ–°æ¸ˆã¿"
            echo "- æ‰‹å‹•ã§ STATUS ãŒå¤‰æ›´ã•ã‚ŒãŸ"
            exit 0
          fi

          # STATUS ã‚’ implementing â†’ completed ã«æ›´æ–°
          # awk ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ¼ã‚¿ãƒ–ãƒ«ã«å®Ÿè£…
          awk '{if ($0 ~ /^STATUS=implementing$/) print "STATUS=completed"; else print}' "$METADATA_FILE" > "$METADATA_FILE.tmp"
          mv "$METADATA_FILE.tmp" "$METADATA_FILE"

          # æ›´æ–°ã‚’ç¢ºèª
          NEW_STATUS=$(grep "^STATUS=" "$METADATA_FILE" | cut -d= -f2)

          if [[ "$NEW_STATUS" != "completed" ]]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: STATUS ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "âŒ æ›´æ–°å¾Œã® STATUS: $NEW_STATUS"
            exit 1
          fi

          echo "âœ“ STATUS ã‚’æ›´æ–°: $CURRENT_STATUS â†’ $NEW_STATUS"

          # Git ã§å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$METADATA_FILE"
          git commit -m "chore: Mark $FEATURE_ID as completed [skip ci]"

          # develop ã«ãƒ—ãƒƒã‚·ãƒ¥
          echo "å¤‰æ›´ã‚’ develop ã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
          git push origin develop

          echo ""
          echo "=========================================="
          echo "âœ… $FEATURE_ID ã® STATUS ã‚’ completed ã«æ›´æ–°ã—ã¾ã—ãŸ"
          echo "=========================================="
          echo ""
          echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "- sync-projects.yml ãŒè‡ªå‹•çš„ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™"
          echo "- GitHub Projects ã® Status ãŒ 'Done' ã«æ›´æ–°ã•ã‚Œã¾ã™"
